 
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML+RDFa 1.1//EN">
<html lang="en" dir="ltr" version="HTML+RDFa 1.1"
xmlns:content="http://purl.org/rss/1.0/modules/content/"
xmlns:dc="http://purl.org/dc/terms/"
xmlns:foaf="http://xmlns.com/foaf/0.1/"
xmlns:og="http://ogp.me/ns#"
xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
xmlns:sioc="http://rdfs.org/sioc/ns#"
xmlns:sioct="http://rdfs.org/sioc/types#"
xmlns:skos="http://www.w3.org/2004/02/skos/core#"
xmlns:xsd="http://www.w3.org/2001/XMLSchema#"
xmlns:schema="http://schema.org/">
<head profile="http://www.w3.org/1999/xhtml/vocab">
<title>Plotting subsets of data on a curvilinear grid - Ferret/PyFerret FAQs</title>

<link rel="stylesheet" href="../modules/system/system.base.css">
<link rel="stylesheet" href="../modules/system/system.menus.css">
<link rel="stylesheet" href="../modules/system/system.messages.css">
<link rel="stylesheet" href="../modules/system/system.theme.css">

<link rel="stylesheet" href="../sites/all/modules/jquery_update/replace/ui/themes/base/minified/jquery.ui.core.min.css">
<link rel="stylesheet" href="../sites/all/modules/jquery_update/replace/ui/themes/base/minified/jquery.ui.theme.min.css">
<link rel="stylesheet" href="../sites/all/modules/jquery_update/replace/ui/themes/base/minified/jquery.ui.menu.min.css">
<link rel="stylesheet" href="../sites/all/modules/jquery_update/replace/ui/themes/base/minified/jquery.ui.autocomplete.min.css">

<link rel="stylesheet" href="../sites/all/modules/calendar/css/calendar_multiday.css">
<link rel="stylesheet" href="../modules/field/theme/field.css">
<link rel="stylesheet" href="../sites/all/modules/scald/modules/fields/mee/css/editor-global.css">
<link rel="stylesheet" href="../modules/node/node.css">
<link rel="stylesheet" href="../sites/all/modules/scald_file/scald_file.css">
<link rel="stylesheet" href="../modules/search/search.css">
<link rel="stylesheet" href="../modules/user/user.css">
<link rel="stylesheet" href="../sites/all/modules/views/css/views.css">
<link rel="stylesheet" href="../sites/all/modules/ckeditor/css/ckeditor.css">

<link rel="stylesheet" href="../sites/all/modules/ctools/css/ctools.css">
<link rel="stylesheet" href="../sites/all/modules/custom_search/custom_search.css">
<link rel="stylesheet" href="../sites/all/modules/search_autocomplete/css/themes/minimal.css">
<link rel="stylesheet" href="../sites/all/libraries/superfish/css/superfish.css">
<link rel="stylesheet" href="../sites/all/libraries/superfish/css/superfish-smallscreen.css">
<link rel="stylesheet" href="../sites/all/libraries/superfish/css/superfish-vertical.css">

<link rel="stylesheet" href="../sites/all/themes/pacific_marine/css/ckeditor_custom.css">

<link rel="stylesheet" href="../sites/all/themes/omega/alpha/css/alpha-reset.css">
<link rel="stylesheet" href="../sites/all/themes/omega/alpha/css/alpha-mobile.css">
<link rel="stylesheet" href="../sites/all/themes/omega/alpha/css/alpha-alpha.css">
<link rel="stylesheet" href="../sites/all/themes/omega/omega/css/formalize.css">
<link rel="stylesheet" href="../sites/all/themes/omega/omega/css/omega-text.css">
<link rel="stylesheet" href="../sites/all/themes/omega/omega/css/omega-branding.css">
<link rel="stylesheet" href="../sites/all/themes/omega/omega/css/omega-menu.css">
<link rel="stylesheet" href="../sites/all/themes/omega/omega/css/omega-forms.css">
<link rel="stylesheet" href="../sites/all/themes/omega/omega/css/omega-visuals.css">
<link rel="stylesheet" href="../sites/all/themes/pacific_marine/css/global.css">



<link rel="stylesheet" href="../sites/all/themes/pacific_marine/css/pacific-marine-alpha-default.css">
<link rel="stylesheet" href="../sites/all/themes/pacific_marine/css/pacific-marine-alpha-default-wide.css">
<link rel="stylesheet" href="../sites/all/themes/omega/alpha/css/grid/alpha_default/wide/alpha-default-wide-12.css">


</head>
<body class="html not-front not-logged-in page-node page-node- page-node-555 node-type-documentation-page context-documentation">
  <div id="body-bg-top"></div>
  <div id="skip-link">
    <a href="#main-content" class="element-invisible element-focusable">Skip to main content</a>
  </div>
    <div class="page clearfix" id="page">
      <header id="section-header" class="section section-header">
  <div id="zone-header-wrapper" class="zone-wrapper zone-header-wrapper clearfix">  
  <div id="zone-header" class="zone zone-header clearfix container-12">
    <div class="grid-7 region region-branding" id="region-branding">
  <div class="region-inner region-branding-inner">
        <div class="branding-data clearfix">
            <div class="logo-img">
        <a href="../index.html" rel="home" title=""><img src="../sites/all/themes/pacific_marine/images/ferret-banner.png" alt="" id="logo" /></a>
		</div>
                </div>
          </div>
</div><div class="grid-5 region region-header-first" id="region-header-first">
  <div class="region-inner region-header-first-inner">
    <div class="block block-block block-4 block-block-4 odd block-without-title" id="block-block-4">
  <div class="block-inner clearfix">

  </div>
</div>
  </div>
</div>  </div>
</div>  </div>
</div><div id="zone-menu-wrapper" class="zone-wrapper zone-menu-wrapper clearfix">  
  <div id="zone-menu" class="zone zone-menu clearfix container-12">
    <div class="grid-12 region region-menu" id="region-menu">
  <div class="region-inner region-menu-inner">
        <div class="block block-system block-menu block-main-menu block-system-main-menu odd block-without-title" id="block-system-main-menu">
  <div class="block-inner clearfix">
                
    <div class="content clearfix">
      <ul class="menu">
	  <li class="first expanded"><a href="../index.html">Home</a>
	  <ul class="menu">
	  </li>
<li class="leaf"><a href="../index.html">Ferret/PyFerret Home</a></li>
</ul></li>
<li class="leaf"><a href="../documentation/ferret-documentation.html">Documentation</a></li>
<li class="leaf"><a href="ferret-faqs.html">FAQ</a></li>
<li class="collapsed"><a href="../documentation/pyferret/downloads.html">Downloads</a></li>
<li class="collapsed"><a href="../documentation/pyferret-support.html">Support</a></li>
</ul>    </div>
  </div>
</div>  </div>
</div>
  </div>
</div></header> 


      <section id="section-content" class="section section-content">
  <div id="zone-preface-wrapper" class="zone-wrapper zone-preface-wrapper clearfix">  
  <div id="zone-preface" class="zone zone-preface clearfix equal-height-container container-12">
    <div class="grid-3 region region-preface-first equal-height-element" id="region-preface-first">
  <div class="region-inner region-preface-first-inner">
      </div>
</div><div class="grid-9 region region-preface-second equal-height-element" id="region-preface-second">
  <div class="region-inner region-preface-second-inner">
      </div>
</div>  </div>
</div><div id="zone-content-wrapper" class="zone-wrapper zone-content-wrapper clearfix no-sidebar">  
  <div id="zone-content" class="zone zone-content clearfix equal-height-container container-12">    
        
        <div class="grid-12 region region-content equal-height-element" id="region-content">
  <div class="region-inner region-content-inner">
    <a id="main-content"></a>
            <div class="element-invisible">   
    </div>                    <div class="block block-system block-main block-system-main odd block-without-title" id="block-system-main">
  <div class="block-inner clearfix">
                
    <div class="content clearfix">
      <article about="/Ferret/index.html" typeof="foaf:Document" class="node node-page node-published node-not-promoted node-not-sticky author-burger odd clearfix" id="node-page-771">

<h2 class="block-title"><a href="ferret-faqs.html" class="active-trail">FAQ</a></h2>
<a id="main-content"></a>
<div class="element-invisible">    <h1 class="title" id="page-title">Plotting subsets of data on a curvilinear grid</h1>
</div>                    <div class="block block-system block-main block-system-main odd block-without-title" id="block-system-main">
<div class="block-inner clearfix">
 
<div class="content clearfix">
<article about="/Ferret/faq/plotting-subsets-of-data-on-a-curvilinear-grid" typeof="foaf:Document" class="node node-page node-published node-not-promoted node-not-sticky author-ansley odd clearfix" id="node-page-689">

<h1 id="page title"  class="node-title">Plotting subsets of data on a curvilinear grid</h1>  <div class="content clearfix">
 
<div class="field field-name-body field-type-text-with-summary field-label-hidden">
<div class="field-items">
<div class="field-item even" property="content:encoded"><h2>Question:</h2>
<p>How can I determine the indices that represent longitude and latitude limits for reading a subset of data on a curvilinear grid?</p>
<h2>Example:</h2>
<p>
We base this example on a variable on the GFDL tri-polar grid (with some changes to the axes of the curvilinear coordinates to make them purely abstract axes).Here is a variable the on the entire grid:</p>
<pre>
shade/nokey/pal=land_sea land_flag, geolon, geolat
 
</pre><h2><img class="image-inline" src="../sites/default/files/images/faq/subsetting_curv_1.gif" /></h2>
<p> </p>
<p>How to specify a subset, say X=-60:60, Y=25:85 ?</p>
<p>
If we just try SHADE/X=/Y= the plot fails, because the X= and Y= apply to the abstract X and Y axes that the curvilinear coordinates are on, and not to the data in the coordinate variables geolon and geolat.</p>
<pre>
shade/x=-60:60/y=25:90/nokey/pal=land_sea land_flag, geolon, geolat
**ERROR: inconsistent sizes of data regions: Y axis of X position array
</pre><p>
We need instead to define a range in I and J to apply to variables land_flag, geolon, and geolat to plot a subset of the data field in curvilinear coordinates.</p>
<p>We want a plot corresponding to this rectilinear basemap plot:</p>
<pre>
go basemap x=-60:60 y=25:85 60 land_sea
</pre><p>
<img class="image-inline" src="../sites/default/files/images/faq/subsetting_curv_2.gif" /></p>
<p> </p>
<p> </p>
<h2>Explanation:</h2>
<p>The curvilinear coordinates for longitude and latitude need to be searched to find the i,j rectangle which contains our latitude, longitude region. This is not directly available from the data, as, for instance, the 2-D longitude coordinate variable contains a different range of longitudes for each j.</p>
<p>If we choose some rectangular region of indices, bounded by i=i1:i2, j=j1:j2,this will not in general correspond to a rectangular region in the curvilinear grid. If we arbitrarily look at a plot with some range of I and J:</p>
<pre>
shade/nokey/i=80:160/j=80:170/pal=land_sea land_flag, geolon, geolat
</pre><p><img class="image-inline" src="../sites/default/files/images/faq/subsetting_curv_3.gif" /></p>
<p> </p>
<p>We will wind up with some oddly-shaped plot; the goal here is to choose ranges of I and J to access a subset of the data that contains all locations in the range X=-60:60, Y=25:85. We can use the tools designed for regridding of curvilinear grids.</p>
<p> </p>
<h2>Solution:</h2>
<p>There are new functions (Ferret V5.80) to regrid data from a curvilinear to a rectangular grid. These are CURV_TO_RECT_MAP, which computes the mapping that will let us regrid from the curvilinear to the rectangular grid, and CURV_TO_RECT which applies this mapping to data fields to carry out the regridding.P&gt;</p>
<p>Variable <i>map</i>, the result of a call to function CURV_TO_RECT_MAP, contains as part of the mapping information, the indices of the longitudes and latitudesof the curvilinear grid that correspond to the coordinates of the output grid. Variables <i>in_curv_lon</i> and <i>in_curv_lat</i> are the index values from the input curvilinear grid that correspond to the longitude and latitude of the rectangular output grid. The parameter <i>num_neighbors</i> is 4; the code looks around at four neighboring grid cells. (The weights are based on the distance from the source 'to the result grid points. We do not need the weights here.)</p>
<pre>
for each m = 1, nlon_out 
for each n = 1, nlat_out
 
for each k=1, num_neighbors
 
MAP(m,n,k,1) = wt(m,n,k)
MAP(m,n,k,2) = in_curv_lon(m,n,k)
MAP(m,n,k,3) = in_curv_lat(m,n,k)
 
</pre><p>The trick we'll use is to define a rectangular grid having a 2-point output longitude axis and a 2-point latitude axis. The coordinates will be the lower and upper longitudes and latitudes of the desired region. Compute the mapping from the curvilinear grid to this rectangular grid, and then the mapping gives the index bounds we need to plot a subset of the curvilinear data.</p>
<pre>
! Input data on a curvilinear grid
 
use "my_data/mom4_grid_example.nc"
 
! Define the corners of our subset: These will define
! the axes of our output grid
 
let xmin = -80
let xmax = 80
let ymin = -45
let ymax = 85
 
def axis/x=`xmin`:`xmax`/npoints=2/modulo/units=degrees xax
def axis/y=`ymin`:`ymax`/npoints=2/units=degrees yax
 
! Define a variable on the output grid
 
let lonlatout = y[gy=yax] + x[gx=xax]
 
! Compute weights for the mapping
 
let map = curv_to_rect_map (geolon_t, geolat_t, lonlatout, 10)
 
 
! The variable <i>map</i> includes the indices within the source 
! grid which correspond to coordinates in the destination grid.
! These are the lower lon and lat and upper lon and lat indices:
 
! e.g. here are the longitude indices (L=2) and latitude indices (L=3)
! the four nearest neighbors (K=1:4) in the curvilinear grid, which map
! to the i=1,j=1 location on the output axes.
 
LIST/I=1/J=1/L=2:3 map
 
1 2 3 4
2 / 2: 100.0 101.0 100.0 101.0
3 / 3: 38.0 38.0 37.0 37.0
 
! Compute the minimum and maximum indices in I and J needed
! to plot the entire region
 
let llon = map[i=1,j=@min,l=2,k=@min]
let llat = map[i=@min,j=1,l=3,k=@min]
 
let ulon = map[i=2,j=@max,l=2,k=@max]
let ulat = map[i=@max,j=2,l=3,k=@max]
 
 
! Draw a shade plot with the 3-argument SHADE command, using
! these indices to constrain the data, longitudes and latitudes.
 
shade/noax ht[i=`llon`:`ulon`,j=`llat`:`ulat`], \
geolon_t[i=`llon`:`ulon`,j=`llat`:`ulat`], \
geolat_t[i=`llon`:`ulon`,j=`llat`:`ulat`]
</pre><p><img class="image-inline" src="../sites/default/files/images/faq/subsetting_curv_4.gif" /></p>
<p> </p>
<p> </p>
<p>Now, what if the region we request crosses the branch point of the original data? Ferret's 3-argument plot commands for curvilinear coordinates do not handle modulo operations. The curvilinear regridding does work with modulo longitudes and returns the correct indices. (CURV_TO_RECT, the function that applies the mapping to regrid data, will correctly regrid data to the output rectangular grid). Say we want to plot the data from longitudes 0 to 120. This data set has its branch point at 80E.</p>
<p> </p>
<p> </p>
<pre>
! Redefine the limits and the output axes
 
let xmin = 0
let xmax = 120
let ymin = -40
let ymax = 80
def axis/x=`xmin`:`xmax`/npoints=2/modulo/units=degrees xax
def axis/y=`ymin`:`ymax`/npoints=2/units=degrees yax
</pre><p>When we compute the lower and upper longitude indices, llon and ulon, the lower index is larger than the upper index. In this example, the index corresponding to the longitude minimum of 0 degrees is 140 and the index corresponding to the longitude maximum of 120 degrees is 29. We willneed to draw the plot in two steps. Create two viewports with the /axes qualifier, sized in proportion to the size of the two segments. First plot the portion from index 1 to the index corresponding to the lower longitude, then the portion from the index corresponding to the upper longitude to the uppermost index in the grid.</p>
<pre>
IF `llon GE ulon` THEN
 
say "Indices for the longitude min, max are `llon`, `ulon`"
say "Requested region crosses branch point of curvilinear data."
say "Draw the plot in two sections"
say " "
say "First section: index i = 1 to `llon`"
say "Second section: index i = `ulon` to `geolon,r=isize`"
 
! First section: index i = 1 to 141
! Second section: index i = 29 to 180 
ENDIF
</pre><p>Putting together sections of curvilinear data will require defining custom viewports and is not covered in this FAQ.</p>
<p> </p>
<hr /></div>
</div>
</div>

</div>

<div class="clearfix">
<nav class="links node-links clearfix"></nav>

</div>
</article>    </div>
</div>
</div>      </div>
</div>  </div>
</div></section>    
 
<footer id="section-footer" class="section section-footer">

  <div id="zone-footer-wrapper" class="zone-wrapper zone-footer-wrapper clearfix">  
  <div id="zone-footer" class="zone zone-footer clearfix container-12">
    <div class="grid-8 region region-footer-first" id="region-footer-first">
  <div class="region-inner region-footer-first-inner">
    <div class="block block-block block-1 block-block-1 odd block-without-title" id="block-block-1">
  <div class="block-inner clearfix">
                
  </div>
</div><div class="block block-block block-2 block-block-2 even block-without-title" id="block-block-2">
  <div class="block-inner clearfix">
                
  </div>
</div><div class="block block-menu block-menu-footer-first-menu block-menu-menu-footer-first-menu odd block-without-title" id="block-menu-menu-footer-first-menu">

  </div>
</div>  </div>
</div><div class="grid-4 region region-footer-second" id="region-footer-second">
  <div class="region-inner region-footer-second-inner">
    <div class="block block-menu block-menu-footer-second-menu block-menu-menu-footer-second-menu odd block-without-title" id="block-menu-menu-footer-second-menu">
  <div class="block-inner clearfix">
                
  </div>
</div>  </div>
</div>  </div>
</div></footer>  </div>  <div class="region region-page-bottom" id="region-page-bottom">
  <div class="region-inner region-page-bottom-inner">
      </div>
</div>  <div id="body-bg-bottom"></div>
</body>
</html>
