<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: Fw: [ferret_users] memory usage creeping up -->
<!--X-From-R13: Yney Ezvgu &#45; @AOO Ossvyvngr <xney.fzvguNabnn.tbi> -->
<!--X-Date: Tue, 9 Jul 2013 13:54:53 &#45;0700 -->
<!--X-Message-Id: CAELLC7U2b9Dfu=jHFHeKXV=fmo=Bj72J4dMK&#45;vubVKmFe6pPsA@mail.gmail.com -->
<!--X-Content-Type: multipart/alternative -->
<!--X-Reference: 1519860.JKMJK0UZMZ@ws&#45;mali -->
<!--X-Reference: 51DAEF07.2000403@noaa.gov -->
<!--X-Reference: 1373384143.41110.YahooMailNeo@web141102.mail.bf1.yahoo.com -->
<!--X-Reference: CAELLC7Un6+vvv4qEdWhaMOr+5GRNJ567oaeU&#45;dJL61fWxyncVw@mail.gmail.com -->
<!--X-Reference: 1373397087.64830.YahooMailNeo@web141103.mail.bf1.yahoo.com -->
<!--X-Reference: 1373401032.75837.YahooMailNeo@web141106.mail.bf1.yahoo.com -->
<!--X-Reference: CAELLC7U&#45;CNYVSkdm66F_SdSec4gFPYe7d0tg8oO5nqWDNC+Bhw@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: Fw: [ferret_users] memory usage creeping up</title>
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<HR>
<center>[<a href="msg00434.html">Thread Prev</a>][<a href="msg00435.html">Thread Next</a>][<A HREF="threads.html#00436">Index</A>]</center>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: Fw: [ferret_users] memory usage creeping up</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><strong>To</strong>: <strong>jean li &lt;<a href="mailto:xgeast@DOMAIN.HIDDEN">xgeast@xxxxxxxxx</a>&gt;</strong></li>
<li><strong>Subject</strong>: <strong>Re: Fw: [ferret_users] memory usage creeping up</strong></li>
<li><strong>From</strong>: <strong>Karl Smith - NOAA Affiliate &lt;<a href="mailto:karl.smith@DOMAIN.HIDDEN">karl.smith@xxxxxxxx</a>&gt;</strong></li>
<li>Date: Tue, 9 Jul 2013 13:54:48 -0700</li>
<li>Cc: ferret &lt;<a href="mailto:ferret_users@DOMAIN.HIDDEN">ferret_users@xxxxxxxx</a>&gt;</li>
<li>In-reply-to: &lt;CAELLC7U-CNYVSkdm66F_SdSec4gFPYe7d0tg8oO5nqWDNC+Bhw@mail.gmail.com&gt;</li>
<li>List-archive: &lt;<a href="http://groups.google.com/a/noaa.gov/group/ferret_users/">http://groups.google.com/a/noaa.gov/group/ferret_users/</a>&gt;</li>
<li>List-help: &lt;<a href="http://support.google.com/a/noaa.gov/bin/topic.py?topic=25838">http://support.google.com/a/noaa.gov/bin/topic.py?topic=25838</a>&gt;, &lt;<a href="mailto:ferret_users+help@noaa.gov">mailto:ferret_users+help@noaa.gov</a>&gt;</li>
<li>List-id: &lt;ferret_users.noaa.gov&gt;</li>
<li>List-post: &lt;<a href="http://groups.google.com/a/noaa.gov/group/ferret_users/post">http://groups.google.com/a/noaa.gov/group/ferret_users/post</a>&gt;, &lt;<a href="mailto:ferret_users@noaa.gov">mailto:ferret_users@noaa.gov</a>&gt;</li>
<li>List-unsubscribe: &lt;<a href="http://groups.google.com/a/noaa.gov/group/ferret_users/subscribe">http://groups.google.com/a/noaa.gov/group/ferret_users/subscribe</a>&gt;, &lt;<a href="mailto:googlegroups-manage+809428289204+unsubscribe@googlegroups.com">mailto:googlegroups-manage+809428289204+unsubscribe@googlegroups.com</a>&gt;</li>
<li>Mailing-list: list <a href="mailto:ferret_users@DOMAIN.HIDDEN">ferret_users@xxxxxxxx</a>; contact <a href="mailto:ferret_users%2Bowners@DOMAIN.HIDDEN">ferret_users+owners@xxxxxxxx</a></li>
<li>References: &lt;1519860.JKMJK0UZMZ@ws-mali&gt;	&lt;<a href="msg00432.html">51DAEF07.2000403@noaa.gov</a>&gt;	&lt;<a href="msg00433.html">1373384143.41110.YahooMailNeo@web141102.mail.bf1.yahoo.com</a>&gt;	&lt;<a href="msg00434.html">CAELLC7Un6+vvv4qEdWhaMOr+5GRNJ567oaeU-dJL61fWxyncVw@mail.gmail.com</a>&gt;	&lt;1373397087.64830.YahooMailNeo@web141103.mail.bf1.yahoo.com&gt;	&lt;1373401032.75837.YahooMailNeo@web141106.mail.bf1.yahoo.com&gt;	&lt;CAELLC7U-CNYVSkdm66F_SdSec4gFPYe7d0tg8oO5nqWDNC+Bhw@mail.gmail.com&gt;</li>
<li>Sender: <a href="mailto:owner-ferret_users@DOMAIN.HIDDEN">owner-ferret_users@xxxxxxxx</a></li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<div dir="ltr">Hi Jean,<br><br>Linux also caches data waiting to be written 
to disk, and so cannot delete this cached memory until the data is 
written to disk.&#xA0; All sync does to force Linux to write to disk all the 
cached data waiting to be written to disk.&#xA0; I have never heard of drop_caches; I suspect it is a custom script written by your IT group.&#xA0; Normally none of this is required since Linux is designed to automatically sync when it is not busy with other things, or when it needs the cache memory.&#xA0; And as I mentioned, normally Linux automatically clears out cached memory when processes need memory.<br>
<br>All those save /append commands will require Linux to read each of those files and then write them back out with the added data.&#xA0; Since Ferret is doing this rather rapidly, I can imagine that it could keep Linux quite busy trying to keep up, especially if disk access not very fast (such as with NFS-mounted disks on a busy network).&#xA0; One thing you could do is add the Ferret command &quot;spawn sync&quot; (which just calls the Linux sync command) inside your loop at the end.&#xA0; This will give Linux a chance to catch up and make sure the new data is written to disk.&#xA0; The loops will go slower because the sync command will not return until all write-cached data on the system is written to disk.&#xA0; But this should keep the write-cached data to a minimum.&#xA0; I would be very reluctant to use drop_caches since I assume it removes all cached data, which normally should never be required.<br>
<div class="gmail_extra"><div class="gmail_quote"><div class="gmail_extra">&#xA0;<span class="HOEnZb"></span><br>Karl<br><br><br><div class="gmail_quote">On Tue, Jul 9, 2013 at 1:17 PM, jean li <span dir="ltr">&lt;<a rel="nofollow" href="mailto:xgeast@xxxxxxxxx" target="_blank">xgeast@xxxxxxxxx</a>&gt;</span> wrote:<br>

<blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div><div style="font-size:12pt;font-family:Courier New,courier,monaco,monospace,sans-serif"><div><span>Hi Karl:</span></div>

<div style="font-style:normal;font-size:16px;background-color:transparent;font-family:Courier New,courier,monaco,monospace,sans-serif"><br><span></span></div><div style="font-style:normal;font-size:16px;background-color:transparent;font-family:Courier New,courier,monaco,monospace,sans-serif">

<span>We use &quot;sync&quot; and &quot;drop_caches&quot; to clean up the old cache.</span></div><span><font color="#888888"><div style="font-style:normal;font-size:16px;background-color:transparent;font-family:Courier New,courier,monaco,monospace,sans-serif">

<br><span></span></div><div style="font-style:normal;font-size:16px;background-color:transparent;font-family:Courier New,courier,monaco,monospace,sans-serif"><span>Jean<br></span></div></font></span><div><div><div>
<br></div>  <div style="font-family:Courier New,courier,monaco,monospace,sans-serif;font-size:12pt"> <div style="font-family:times new roman,new york,times,serif;font-size:12pt"> <div dir="ltr"> ----- Forwarded Message -----<br>

  <font face="Arial"> <b><span style="font-weight:bold">From:</span></b> jean li &lt;<a rel="nofollow" href="mailto:xgeast@xxxxxxxxx" target="_blank">xgeast@xxxxxxxxx</a>&gt;<br> <b><span style="font-weight:bold">To:</span></b> Karl Smith - NOAA Affiliate &lt;<a rel="nofollow" href="mailto:karl.smith@xxxxxxxx" target="_blank">karl.smith@xxxxxxxx</a>&gt; <br>

 <b><span style="font-weight:bold">Sent:</span></b> Tuesday, July 9, 2013 3:11 PM<br> <b><span style="font-weight:bold">Subject:</span></b> Re: [ferret_users] memory usage creeping up<br> </font> </div> <div><br><div><div>

<div style="font-size:12pt;font-family:times new roman,new york,times,serif">Hi Karl:<br><br>Thanks for your quick reply. Sorry that I haven&#39;t
 explained my problem clearly. I don&#39;t have any errors related to memory usage.<br><br>I think you are right. The problem has something to do with that the Linux cannot delete the cached data in the memory.&#xA0; And we have to use &quot;sync&quot; to free up all the memory. This problem gets so bad that we have to use a crontab script and run this script on a daily basis. <br>

<br>However, I also run other programs on these machines, e.g. matlab and Fortran, which use a lot of memory as well. But I haven&#39;t noticed this problem when running Matlab or Fortran. Matlab will crash the system if there is not enough memory.<br>

<br><div style="font-style:normal;font-size:16px;background-color:transparent;font-family:times new roman,new york,times,serif"><span>FYI. Below is my ferret script that causes the memory to creep up. <br></span></div><div style="font-style:normal;font-size:16px;background-color:transparent;font-family:times new roman,new york,times,serif">

<span>-----------------<br></span></div><div>repeat/range=904:987/name=m (use &quot;/home/liz/Arctic_2012/arctic_ll_`m`.nc&quot;;\<br>save/append/file=&quot;/home/liz/Arctic_2012/<a rel="nofollow" href="http://wind_1996_temp.nc" target="_blank">wind_1996_temp.nc</a>&quot; uwind_ll, vwind_ll;\<br>

save/append/file=&quot;/home/liz/Arctic_2012/<a rel="nofollow" href="http://current_1996_temp.nc" target="_blank">current_1996_temp.nc</a>&quot; u_ll, v_ll;\<br>save/append/file=&quot;/home/liz/Arctic_2012/<a rel="nofollow" href="http://ice_1996_temp.nc" target="_blank">ice_1996_temp.nc</a>&quot; uice_ll, vice_ll, aice_ll;\<br>

can data &quot;/home/liz/Arctic_2012/arctic_ll_`m`.nc&quot;;\<br>can data/all;\<br>can memory)</div><div><br></div><div style="font-style:normal;font-size:16px;background-color:transparent;font-family:times new roman,new york,times,serif">

The wind*.nc etc files are at 2-3 GB. Each input file is at 100MB.&#xA0; After I
 run this script a few times, the memory is all used up. <br></div><div style="font-style:normal;font-size:16px;background-color:transparent;font-family:times new roman,new york,times,serif"><br></div><div style="font-style:normal;font-size:16px;background-color:transparent;font-family:times new roman,new york,times,serif">

Thanks again for your help.</div><div style="font-style:normal;font-size:16px;background-color:transparent;font-family:times new roman,new york,times,serif"><br></div><div style="font-style:normal;font-size:16px;background-color:transparent;font-family:times new roman,new york,times,serif">

Jean<br></div><div style="font-style:normal;font-size:16px;background-color:transparent;font-family:times new roman,new york,times,serif"><br></div>  <div style="font-family:times new roman,new york,times,serif;font-size:12pt">

 <div style="font-family:times new roman,new york,times,serif;font-size:12pt"> <div dir="ltr"> <hr size="1">  <font face="Arial"> <b><span style="font-weight:bold">From:</span></b> Karl Smith - NOAA Affiliate &lt;<a rel="nofollow" href="mailto:karl.smith@xxxxxxxx" target="_blank">karl.smith@xxxxxxxx</a>&gt;<br>

 <b><span style="font-weight:bold">To:</span></b> jean li &lt;<a rel="nofollow" href="mailto:xgeast@xxxxxxxxx" target="_blank">xgeast@xxxxxxxxx</a>&gt; <br><b><span style="font-weight:bold">Cc:</span></b> &quot;<a rel="nofollow" href="mailto:ferret_users@xxxxxxxx" target="_blank">ferret_users@xxxxxxxx</a>&quot; &lt;<a rel="nofollow" href="mailto:ferret_users@xxxxxxxx" target="_blank">ferret_users@xxxxxxxx</a>&gt; <br>

 <b><span style="font-weight:bold">Sent:</span></b> Tuesday, July 9, 2013 1:27 PM<br> <b><span style="font-weight:bold">Subject:</span></b> Re: [ferret_users] memory usage creeping up<br> </font> </div> <div><br><div><div dir="ltr">

<div><div><div>Hi Jean,<br><br></div>Once Ferret quits, it is not possible for the program to keep memory reserved.&#xA0; You can use the Linux command &quot;ps -fu &lt;username&gt;&quot; (where &lt;username&gt;
 is you username on the machine) to display all processes you are running if you want to verify Ferret is no longer around.&#xA0; If there is still a ferret process running when you think you have exited all of them, you can use the Linux kill command to kill the runaway process (using the PID given in the ps command).&#xA0; <br>


<br>Linux (like most operating systems) does cache data read from disk, so what you may be noticing is the data from your data sets that you use being held in cache memory.&#xA0; However, if Linux needs more memory for some process, it will delete the oldest cached data and use that memory.&#xA0; So you will never get an out-of-memory error message just because a large amount of your memory happens to be used for caching data.&#xA0; You did not indicate whether you were getting an errors because of the memory usage.<br>


<br></div>Another thing to note with Ferret is the cancel data and cancel memory Ferret commands will not return memory to the operating system (one exception: when using string arrays - see below).&#xA0; Only changing the size given with the set memory Ferret command will do that.&#xA0; <br>


<br>If you are using string arrays, the memory for the strings are allocated separately from system memory, so cancelling string arrays will return memory to the system.&#xA0; But use of string arrays is very rare.<br><br></div>


<div>Regards,<br></div>Karl<br><br></div><div><br><br><div>On Tue, Jul 9, 2013 at 8:35 AM, jean li <span dir="ltr">&lt;<a rel="nofollow" rel="nofollow" href="mailto:xgeast@xxxxxxxxx" target="_blank">xgeast@xxxxxxxxx</a>&gt;</span> wrote:<br>


<blockquote style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div><div style="font-size:12pt;font-family:times new roman,new york,times,serif">Hi All:<br><br>I find that the memory usage creeping up after using Ferret. Even if I quit Ferret session, the memory couldn&#39;t be released. In my ferret code, I use<br>


cancel data and cancel memory but that doesn&#39;t seem to help. &#xA0; I could process the data with&#xA0; &quot;set mem/size=1500&quot;, but after a few runs, it filled up the memory of a 65G Linux cluster.&#xA0; The same problem occurred on my Linux (Dell) workstation as well. I am using ferret v6.64 on a 64 bit red hat Linux.<br>


<br>Thanks for your help.<br><br>Jean <br><br><div><span><br></span></div><div><br></div>  <div style="font-family:times new roman,new york,times,serif;font-size:12pt"> <div style="font-family:times new roman,new york,times,serif;font-size:12pt">


 <div dir="ltr"> <hr size="1"><font face="Arial"><b><span style="font-weight:bold"></span></b></font></div><div><br></div> </div> </div>  </div></div></blockquote></div><br><br clear="all"><br>-- <br>Karl M. Smith, Ph.D.<br>


JISAO Univ. Wash. and TMAP/PMEL NOAA<br>&quot;The contents of this message are mine personally and do<br>not necessarily reflect any position of the Government<br>or the National Oceanic and Atmospheric Administration.&quot;<br>



</div></div><br><br></div> </div> </div>  </div></div></div><br><br></div> </div> </div>  </div></div></div></div></blockquote></div><br><br clear="all"><br>-- <br>Karl M. Smith, Ph.D.<br>JISAO Univ. Wash. and TMAP/PMEL NOAA<br>

&quot;The contents of this message are mine personally and do<br>not necessarily reflect any position of the Government<br>or the National Oceanic and Atmospheric Administration.&quot;<br>
</div><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div class="HOEnZb"><div class="h5">
</div></div></blockquote></div><br><br clear="all"><br>-- <br>Karl M. Smith, Ph.D.<br>JISAO Univ. Wash. and TMAP/PMEL NOAA<br>&quot;The contents of this message are mine personally and do<br>not necessarily reflect any position of the Government<br>
or the National Oceanic and Atmospheric Administration.&quot;<br>
</div></div>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00427" href="msg00427.html">[ferret_users] problem with merging time series data files</a></strong>
<ul><li><em>From:</em> Malgorzata Liszewska</li></ul></li>
<li><strong><a name="00432" href="msg00432.html">Re: [ferret_users] problem with merging time series data files</a></strong>
<ul><li><em>From:</em> Ansley Manke</li></ul></li>
<li><strong><a name="00433" href="msg00433.html">[ferret_users] memory usage creeping up</a></strong>
<ul><li><em>From:</em> jean li</li></ul></li>
<li><strong><a name="00434" href="msg00434.html">Re: [ferret_users] memory usage creeping up</a></strong>
<ul><li><em>From:</em> Karl Smith - NOAA Affiliate</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<UL>
<li>Previous by thread:
<strong><a href="msg00434.html">Re: [ferret_users] memory usage creeping up</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00435.html">[ferret_users] Limit on number of variables has been reached</a></strong>
</li>

</UL>
<center>[<a href="msg00434.html">Thread Prev</a>][<a href="msg00435.html">Thread Next</a>][<A HREF="threads.html#00436">Index</A>]</center>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<A HREF="http://ferret.pmel.noaa.gov/Ferret/contact-us">Contact Us</A>
<br>
<font size=-1>
<address>
<a href="http://www.doc.gov">Dept of Commerce</a> /
<a href="http://www.noaa.gov">NOAA</a> /
<a href="http://www.oar.noaa.gov">OAR</a> /
<a href="http://www.pmel.noaa.gov">PMEL</a> /
<a href="http://ferret.pmel.noaa.gov">Ferret</a>
</address>

<br>
 <a href="http://www.noaa.gov/privacy.html">Privacy Policy</a> | <a href="http://www.noaa.gov/disclaimer.html">Disclaimer</a> | <a href="accessibility.html">Accessibility Statement</a> 

</font>
<!--X-User-Footer-End-->
</body>
</html>
