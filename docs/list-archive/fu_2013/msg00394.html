<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: [ferret_users] missing value not detected in double&#45;precision ferret -->
<!--X-From-R13: Vryyn Dvrqr <uryyn.evrqrNzcvp.qr> -->
<!--X-Date: Mon, 10 Jun 2013 17:29:45 &#45;0700 -->
<!--X-Message-Id: 51B66F69.3050202@mpic.de -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 51B6027C.7010700@mpic.de -->
<!--X-Reference: 51B64176.6080105@mpic.de -->
<!--X-Reference: 51B6596E.6020201@noaa.gov -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: [ferret_users] missing value not detected in double-precision ferret</title>
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<HR>
<center>[<a href="msg00393.html">Thread Prev</a>][<a href="msg00395.html">Thread Next</a>][<A HREF="threads.html#00394">Index</A>]</center>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [ferret_users] missing value not detected in double-precision ferret</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><strong>To</strong>: <strong>Ansley Manke &lt;<a href="mailto:ansley.b.manke@DOMAIN.HIDDEN">ansley.b.manke@xxxxxxxx</a>&gt;</strong></li>
<li><strong>Subject</strong>: <strong>Re: [ferret_users] missing value not detected in double-precision ferret</strong></li>
<li><strong>From</strong>: <strong>Hella Riede &lt;<a href="mailto:hella.riede@DOMAIN.HIDDEN">hella.riede@xxxxxxx</a>&gt;</strong></li>
<li>Date: Tue, 11 Jun 2013 02:29:29 +0200</li>
<li>Cc: Ferret Users &lt;<a href="mailto:ferret_users@DOMAIN.HIDDEN">ferret_users@xxxxxxxx</a>&gt;,        Patrick J&#xF6;ckel	&lt;<a href="mailto:patrick.joeckel@DOMAIN.HIDDEN">patrick.joeckel@xxxxxx</a>&gt;</li>
<li>In-reply-to: &lt;<a href="msg00393.html">51B6596E.6020201@noaa.gov</a>&gt;</li>
<li>List-archive: &lt;<a href="http://groups.google.com/a/noaa.gov/group/ferret_users/?hl=en_US">http://groups.google.com/a/noaa.gov/group/ferret_users/?hl=en_US</a>&gt;</li>
<li>List-help: &lt;<a href="http://support.google.com/a/noaa.gov/bin/topic.py?hl=en_US&topic=25838">http://support.google.com/a/noaa.gov/bin/topic.py?hl=en_US&topic=25838</a>&gt;, &lt;<a href="mailto:ferret_users+help@noaa.gov">mailto:ferret_users+help@noaa.gov</a>&gt;</li>
<li>List-id: &lt;ferret_users.noaa.gov&gt;</li>
<li>List-post: &lt;<a href="http://groups.google.com/a/noaa.gov/group/ferret_users/post?hl=en_US">http://groups.google.com/a/noaa.gov/group/ferret_users/post?hl=en_US</a>&gt;, &lt;<a href="mailto:ferret_users@noaa.gov">mailto:ferret_users@noaa.gov</a>&gt;</li>
<li>List-unsubscribe: &lt;<a href="http://groups.google.com/a/noaa.gov/group/ferret_users/subscribe?hl=en_US">http://groups.google.com/a/noaa.gov/group/ferret_users/subscribe?hl=en_US</a>&gt;, &lt;<a href="mailto:googlegroups-manage+809428289204+unsubscribe@googlegroups.com">mailto:googlegroups-manage+809428289204+unsubscribe@googlegroups.com</a>&gt;</li>
<li>Mailing-list: list <a href="mailto:ferret_users@DOMAIN.HIDDEN">ferret_users@xxxxxxxx</a>; contact <a href="mailto:ferret_users%2Bowners@DOMAIN.HIDDEN">ferret_users+owners@xxxxxxxx</a></li>
<li>References: &lt;51B6027C.7010700@mpic.de&gt; &lt;<a href="msg00392.html">51B64176.6080105@mpic.de</a>&gt; &lt;<a href="msg00393.html">51B6596E.6020201@noaa.gov</a>&gt;</li>
<li>Sender: <a href="mailto:owner-ferret_users@DOMAIN.HIDDEN">owner-ferret_users@xxxxxxxx</a></li>
<li>User-agent: Mozilla/5.0 (X11; Linux x86_64; rv:17.0) Gecko/20130510 Thunderbird/17.0.6</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">
Dear Ansley,

thanks for picking up on that so quickly.

</pre><tt>Actually, I'd made a blunder: in the file 'ex_float_missing' I tried 
</tt><tt>exactly what you suggested now, but declared the attribute as 'missing' 
</tt><tt>instead of 'missing_value'. I corrected this now, and it doesn't solve 
</tt><tt>the issue. By contrast, adding a '_FillValue' works - good point.
</tt><pre style="margin: 0em;">

</pre><tt>I am curious as to what Patrick has to say about this. He's the main 
</tt><tt>model maintainer and has a better overview over all the projects 
</tt><tt>distributed over several institutes.
</tt><pre style="margin: 0em;">

He or I will get back to you directly or via the list.

Best wishes and good night (over here),
Hella



On 11/06/13 00:55, Ansley Manke wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Hi Hella,
I don't have a complete answer, but here is what I know, and one
possible solution. We can continue to work with this issue and see if we
can come up with a satisfactory answer.

Is it the case that your files do not have missing_value or _FillValue
attributes?  The CF standard states that if there is a value to be
treated as the missing value, then it should be listed in a _FillValue
attribute.
<a  rel="nofollow" href="http://cf-pcmdi.llnl.gov/documents/cf-conventions/1.6/ch02s05.html#missing-data">http://cf-pcmdi.llnl.gov/documents/cf-conventions/1.6/ch02s05.html#missing-data</a>

For these variables without missing-data attributes, Ferret just assigns
its default bad-value flag value to the variable. When you do this

     yes? use ex_float.nc
     yes? list press
     yes? list `press,return=bad`
       !-&gt; MESSAGE/CONTINUE -1.E+34
     -1.E+34

we are listing out the default bad-value that Ferret uses for all
variables, if none has been assigned by the dataset or by other Ferret
commands.  It is not getting that information from the dataset. If the
internal representation of the data as it is read in, exactly matches
the default bad-value flag as stored internally within Ferret, then the
data would be treated as missing.  This apparently did happen case with
single-precision Ferret.

The NetCDF library gives us calls to read data and attributes  from
their floating-point file values and load them into double-precision
internal storage.  Likewise we can make calls to write data in other
data types than the internal double-precision representation. If we let
the netCDF library do all of the the conversion between float and
double, we can have a netCDF file with floating point data and a
missing-flag of -1.e34 that is recognized,

     yes? use ex_float.nc

     ! Define a new variable that includes missing data, write it out as
     a floating-point variable:

     yes? let pvals = {1.e4,,1.e5}
     yes? let/title=pressure/units=pa pressure = reshape(pvals, press[d=1])

     yes? save/file=test.nc/outtype=float/clobber pressure
       LISTing to file test.nc

     yes? can var/all
     yes? use test.nc
     yes? list pressure
                   VARIABLE : pressure (pa)
                   FILENAME : test.nc
                   SUBSET   : 3 points (TIME)
       01-JAN-2000 00:20:00 / 1:   10000.
       01-JAN-2000 00:40:00 / 2:     ....
       01-JAN-2000 01:00:00 / 3:  100000.

So the netCDF library reading and writing data is consistent within
itself.  It does not seem to work to try to assign the missing_value
attribute to the variable after the file is opened, because we really
need the netCDF library to do the conversions in a way that is self
consistent.

Would it be an option for your group to use NCO to add a _FillValue
attribute to your datasets?  Have a look at this Ferret session.  I made
a copy of your file ex_float.nc,

     yes? use copy_of_ex_float.nc
     yes? sh att press
           attributes for dataset: ./copy_of_ex_float.nc
       press.long_name = pressure
       press.units = Pa

     yes? can dat/all
     yes? let status = nco_attr(&quot;copy_of_ex_float.nc&quot;, &quot;press&quot;,
     &quot;_FillValue&quot;, &quot;f&quot;, &quot;a&quot;, &quot;-1.e+34&quot;)
     yes? load status

     yes? list status
                   VARIABLE : NCO_ATTR(&quot;copy_of_ex_float.nc&quot;, &quot;press&quot;,
     &quot;_FillValue&quot;, &quot;f&quot;, &quot;a&quot;, &quot;-1.e+34&quot;)
                   X        : 1
                1.000

     yes? ! Now it has the _FillValue attribute

     yes? use copy_of_ex_float.nc
     yes? sh att press
           attributes for dataset: ./copy_of_ex_float.nc
       press.long_name = pressure
       press.units = Pa
       press._FillValue = -1.E+34

     yes? list press
                   VARIABLE : pressure (Pa)
                   FILENAME : copy_of_ex_float.nc
                   SUBSET   : 3 points (TIME)
       01-JAN-2000 00:20:00 / 1:   10000.
       01-JAN-2000 00:40:00 / 2:     ....
       01-JAN-2000 01:00:00 / 3:  100020.


Of course you can call NCO from the Unix command line.

On 6/10/2013 2:13 PM, Hella Riede wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
Dear ferret list,

there is a problem reading our climate model netcdf files with the new
ferret double precision version. I boiled it down to a set of small
files in the attachment.

'-1E+34' is not recognized as 'missing value' (see 'ex_float'). To save
space, all variables except dimensional variables in our climate model
output are defined as &quot;float&quot; = &quot;single precision&quot;.

When a netcdf file is read into double-precision ferret, the entry
'-1E+34' in a float (single precision) variable is not recognized as
'missing value' anymore, but has a numerical value of
-9.999999790214768E+33 (prec=16). The bad values are thus not masked,
which is inconvenient for plotting or analysis.

yes? list press
                 VARIABLE : pressure (Pa)
                 FILENAME : ex_float.nc
                 SUBSET   : 3 points (TIME)
     01-JAN-2000 00:20:00 / 1:  1.000E+04
     01-JAN-2000 00:40:00 / 2: -1.000E+34
     01-JAN-2000 01:00:00 / 3:  1.000E+05

The workaround 'set var/bad=-9.999999790214768E+33
&lt;variable&gt;' is inconvenient as well.

Interestingly, when listing the bad value of the variable, the bad-value
masking seems to work:

yes? list `press,ret=bad`
     !-&gt; list -1.E+34
                 VARIABLE : constant
            ....

In 'ex_double' (attachment), I exchanged 'float' to 'double' by hand for
all variables. The value '-1E+34' is then recognized correctly:

yes? list press
                 VARIABLE : pressure (Pa)
                 FILENAME : ex_traj2.nc
                 SUBSET   : 3 points (TIME)
     01-JAN-2000 00:20:00 / 1:   10000.
     01-JAN-2000 00:40:00 / 2:     ....
     01-JAN-2000 01:00:00 / 3:  100020.

The explicit definition of a missing value in the netCDF file does not
solve the issue (attachment: ex_float_missing).

Please help us with backwards compatibility as we cannot go into several
terabyte of climate data output to change &quot;float&quot; to &quot;double&quot; in the
variable definitions.


Thanks a lot in advance,
Hella
</pre></blockquote></blockquote><pre style="margin: 0em;">

</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00392" href="msg00392.html">[ferret_users] missing value not detected in double-precision ferret</a></strong>
<ul><li><em>From:</em> Hella Riede</li></ul></li>
<li><strong><a name="00393" href="msg00393.html">Re: [ferret_users] missing value not detected in double-precision ferret</a></strong>
<ul><li><em>From:</em> Ansley Manke</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<UL>
<li>Previous by thread:
<strong><a href="msg00393.html">Re: [ferret_users] missing value not detected in double-precision ferret</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00395.html">Re: [ferret_users] missing value not detected in double-precision ferret</a></strong>
</li>

</UL>
<center>[<a href="msg00393.html">Thread Prev</a>][<a href="msg00395.html">Thread Next</a>][<A HREF="threads.html#00394">Index</A>]</center>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<A HREF="http://ferret.pmel.noaa.gov/Ferret/contact-us">Contact Us</A>
<br>
<font size=-1>
<address>
<a href="http://www.doc.gov">Dept of Commerce</a> /
<a href="http://www.noaa.gov">NOAA</a> /
<a href="http://www.oar.noaa.gov">OAR</a> /
<a href="http://www.pmel.noaa.gov">PMEL</a> /
<a href="http://ferret.pmel.noaa.gov">Ferret</a>
</address>

<br>
 <a href="http://www.noaa.gov/privacy.html">Privacy Policy</a> | <a href="http://www.noaa.gov/disclaimer.html">Disclaimer</a> | <a href="accessibility.html">Accessibility Statement</a> 

</font>
<!--X-User-Footer-End-->
</body>
</html>
