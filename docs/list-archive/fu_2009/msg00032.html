<!-- MHonArc v2.6.16 -->
<!--X-Subject: Re: [ferret_users] indefinite integral, axis, regrid and context -->
<!--X-From-R13: Rnivq Inat <pyvzngreNtznvy.pbz> -->
<!--X-Date: Sat, 17 Jan 2009 16:51:26 &#45;0800 -->
<!--X-Message-Id: 8be1369e0901171651r2fc74532y3d801cc1574c83c4@mail.gmail.com -->
<!--X-Content-Type: multipart/alternative -->
<!--X-Reference: 8be1369e0901170934t7dfd8413q5137dd396ececaa2@mail.gmail.com -->
<!--X-Reference: 0140FD6F&#45;5170&#45;406A&#45;8407&#45;F476D1B31833@noaa.gov -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: [ferret_users] indefinite integral, axis, regrid and context</title>
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<HR>
<center>[<a href="msg00031.html">Thread Prev</a>][<a href="msg00035.html">Thread Next</a>][<A HREF="threads.html#00032">Index</A>]</center>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [ferret_users] indefinite integral, axis, regrid and context</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><strong>To</strong>: <strong>&quot;William.S.Kessler&quot; &lt;<a href="mailto:William.S.Kessler@DOMAIN.HIDDEN">William.S.Kessler@xxxxxxxx</a>&gt;</strong></li>
<li><strong>Subject</strong>: <strong>Re: [ferret_users] indefinite integral, axis, regrid and context</strong></li>
<li><strong>From</strong>: <strong>David Wang &lt;<a href="mailto:climater@DOMAIN.HIDDEN">climater@xxxxxxxxx</a>&gt;</strong></li>
<li>Date: Sat, 17 Jan 2009 19:51:22 -0500</li>
<li>Cc: <a href="mailto:oar.pmel.ferret_users@DOMAIN.HIDDEN">oar.pmel.ferret_users@xxxxxxxx</a></li>
<li>Dkim-signature: v=1; a=rsa-sha256; c=relaxed/relaxed;        d=gmail.com; s=gamma; h=domainkey-signature:mime-version:received:in-reply-to:references :date:message-id:subject:from:to:cc:content-type; bh=qb+I60Im5P3HzECMApvOhB3HOuRpQWUTRday/xsHtm0=; b=QBtCkf6VcOmFwi1uyQx8pixD1O3QDObRXo1PStH4RM+KvVOWjsaCIrAbytQIjIiTBQ eKHn3rVRtQs8qAUYTsjAH0jIFBQK7ZCHXdCX00sKfjWr4nPnMQru3hVbBwyJ0KN+3L4y Vd4gQyRQQn7mfLw6m0CB/p//S49dWxRT2MYn8=</li>
<li>Domainkey-signature: a=rsa-sha1; c=nofws;        d=gmail.com; s=gamma; h=mime-version:in-reply-to:references:date:message-id:subject:from:to :cc:content-type; b=t7nfdBmNOB9VmWsu4H7Dctlob3vCM6VP5zuSCCubhssanlrjubWaQfXIE6azhcHCqH 7zlKMBM9nrUMT6qNjU3gtkc2L6eVQch6+OM3xcxTXNGM9aInS3BhWdyf8fNzaCiTEv5Z ty2bt+5Wr/kGUdK1Egf+tnemGlPHGEr8I9aOE=</li>
<li>In-reply-to: &lt;<a href="mailto:0140FD6F-5170-406A-8407-F476D1B31833@DOMAIN.HIDDEN">0140FD6F-5170-406A-8407-F476D1B31833@xxxxxxxx</a>&gt;</li>
<li>References: &lt;<a href="mailto:8be1369e0901170934t7dfd8413q5137dd396ececaa2@DOMAIN.HIDDEN">8be1369e0901170934t7dfd8413q5137dd396ececaa2@xxxxxxxxxxxxxx</a>&gt; &lt;<a href="mailto:0140FD6F-5170-406A-8407-F476D1B31833@DOMAIN.HIDDEN">0140FD6F-5170-406A-8407-F476D1B31833@xxxxxxxx</a>&gt;</li>
<li>Sender: <a href="mailto:owner-ferret_users@DOMAIN.HIDDEN">owner-ferret_users@xxxxxxxx</a></li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
Hi Billy,<br><br>Thanks you! This is a nice workaround.<br><br>I was aware of the way Ferret realizes an _expression_. But I don&#39;t understand, as you pointed out, the latest grid at the point of _expression_ (re-)evaluation is that of &quot;basin&quot;. Haven&#39;t I regridded this variable basin onto the wind grid in the if-then masking command defining the variable psi_pac?<br>
<br>David<br><br><div class="gmail_quote">On Sat, Jan 17, 2009 at 6:55 PM, William.S.Kessler <span dir="ltr">&lt;<a rel="nofollow" href="mailto:William.S.Kessler@xxxxxxxx">William.S.Kessler@xxxxxxxx</a>&gt;</span> wrote:<br><blockquote class="gmail_quote" style="border-left: 1px solid rgb(204, 204, 204); margin: 0pt 0pt 0pt 0.8ex; padding-left: 1ex;">
I&#39;m not sure if this is the real answer, but one of Ferret&#39;s strengths/weaknesses is that definitions are evaluated when a variable is used. Thus when you define the masked variable curl_pac, and then plot it, the @iin in the definition of psi is reevaluated on its latest grid (which is that of the masking variable basin).<br>

<br>
A klugey way to get around this is to SAVE the intermediate variable to freeze the evaluation of @iin:<br>
<br>
yes? let savepsi=psi &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;! define this dummy to avoid having to CAN VAR PSI when it is read back in<br>
yes? save/file=junk.cdf savepsi<br>
LISTing to file junk.cdf<br>
yes? can var savepsi &nbsp; &nbsp; &nbsp; ! remove the dummy definition<br>
yes? use junk.cdf<br>
yes? let savepsi0=if basin[d=2,gxy=psi@nrst,k=1] eq 2 then savepsi<br>
yes? shade/x=100e:290e savepsi0 &nbsp; &nbsp; ! note specification of x-limits<br>
<br>
This produces the plot you want. That fact that this works makes me thinks the problem is the reevaluation of @iin. I agree that this is inelegant, but sometimes intermediate saves are the easiest way to get a result.<br>

<br>
Billy K<div><div></div><div class="Wj3C7c"><br>
<br>
On 17/01/2009, at 9:34 AM, David Wang wrote:<br>
<br>
<blockquote class="gmail_quote" style="border-left: 1px solid rgb(204, 204, 204); margin: 0pt 0pt 0pt 0.8ex; padding-left: 1ex;">
Hi Ferreters,<br>
<br>
I&#39;ve run into trouble with @iin indefinite integral but wasn&#39;t able to pin down the source of error. I wrote a script meant to give me a quick look at the Sverdrup streamfunction in the tropical Pacific from a given wind stress curl. My basic idea is to first mask out the wind stress curl outside the Pacific basin with zero, do the zonal indefinite integration westward, then mask out the resulting streamfunction in all basins except the Pacific. Here is the code using the publicly available wind data (Trenberth et al. 1990) and mask:<br>

<br>
\can mode verify<br>
<br>
can data/a<br>
can region<br>
<br>
! Load annual wind stress curl and basin mask files<br>
use &quot;<a rel="nofollow" href="http://iridl.ldeo.columbia.edu/SOURCES/.TRENBERTH/.Annual/dods" target="_blank">http://iridl.ldeo.columbia.edu/SOURCES/.TRENBERTH/.Annual/dods</a>&quot;<br>
use &quot;<a rel="nofollow" href="http://iridl.ldeo.columbia.edu/" target="_blank">http://iridl.ldeo.columbia.edu/</a>SOURCES/.NOAA/.NODC/.WOA05/.Masks/.basin/dods&quot;<br>
<br>
! Mask out all basins but the Pacific<br>
let curl_pac = if basin[d=2,gxy=curl[d=1]@nrst,k=1] eq 2 then curl[d=1]/1e8 else 0<br>
<br>
! Calculate Rossby parameter \beta<br>
let f = (2*7.29212e-5) * sin(y[gy=curl_pac]*(4*atan(1.)/180))<br>
let beta = f[y=@ddc]<br>
<br>
! Calculate Sverdrup streamfunction (in Sv)<br>
let psi = (-1)*(curl_pac[x=0:360@din]-curl_pac[x=0:360@iin])/beta/1027/1e6<br>
<br>
! Mask out all basin but the Pacific<br>
let psi_pac = if basin[d=2,gxy=psi@nrst,k=1] eq 2 then psi<br>
<br>
! Show me the result<br>
sha/line/key/@t psi_pac<br>
<br>
Things are still OK after psi is defined (try sha psi). However the masked variable psi_pac has become erroneous (try sha psi_pac). And the last command, with a specified context (@t), issues an error msg complaining inconsistent sizes. I found it tricky to figure out what goes wrong in such a script with indefinite integral, regridding between different axes (the x axis starts at 180E (-180) in curl[d=1] while 0.5E in basin[d=2]) and the interplay between indefinite integral and context. Does anyone has a clue please?<br>

</blockquote>
<br>
</div></div></blockquote></div><br><br clear="all"><br>-- <br>life grows, death doesn&#39;t.<br>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00030" href="msg00030.html">[ferret_users] indefinite integral, axis, regrid and context</a></strong>
<ul><li><em>From:</em> David Wang</li></ul></li>
<li><strong><a name="00031" href="msg00031.html">Re: [ferret_users] indefinite integral, axis, regrid and context</a></strong>
<ul><li><em>From:</em> William.S.Kessler</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<UL>
<li>Previous by thread:
<strong><a href="msg00031.html">Re: [ferret_users] indefinite integral, axis, regrid and context</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00035.html">[ferret_users] Calendar type for descriptor file</a></strong>
</li>

</UL>
<center>[<a href="msg00031.html">Thread Prev</a>][<a href="msg00035.html">Thread Next</a>][<A HREF="threads.html#00032">Index</A>]</center>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<hr>
<A HREF="ferret_contact_us.html">Contact Us</A>
<br>
<font size=-1>
<address>
<a href="http://www.doc.gov">Dept of Commerce</a> / 
<a href="http://www.noaa.gov">NOAA</a> /
<a href="http://www.oar.noaa.gov">OAR</a> /
<a href="http://www.pmel.noaa.gov">PMEL</a> /
<a href="http://tmap.pmel.noaa.gov">TMAP</a>
</address>
<br>
 <a href="http://www.noaa.gov/privacy.html">Privacy Policy</a> | <a href="http://www.noaa.gov/disclaimer.html">Disclaimer</a> | <a href="accessibility.html">Accessibility Statement</a> 
</font>
<!--X-User-Footer-End-->
</body>
</html>
