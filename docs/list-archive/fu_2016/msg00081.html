<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: [ferret_users] Compressed ferret output incompatibe with netcdf java apps -->
<!--X-From-R13: "Oafyrl Q. [naxr" <nafyrl.o.znaxrNabnn.tbi> -->
<!--X-Date: Mon, 8 Feb 2016 15:32:41 &#45;0800 -->
<!--X-Message-Id: 56B92596.20703@noaa.gov -->
<!--X-Content-Type: multipart/alternative -->
<!--X-Reference: alpine.LFD.2.10.1601191052420.1594@kelvin -->
<!--X-Reference: alpine.LFD.2.10.1601191158010.1594@kelvin -->
<!--X-Reference: 569E782B.709@noaa.gov -->
<!--X-Reference: alpine.LFD.2.10.1601191444300.1594@kelvin -->
<!--X-Reference: 56A2C344.7090007@io&#45;warnemuende.de -->
<!--X-Reference: CAELLC7U_0XJ=L&#45;N6jMrpk&#45;2nQ&#45;3+0pQAj_sbkD8ydrfJ+3RY4g@mail.gmail.com -->
<!--X-Reference: 56AB0C1F.5070702@csiro.au -->
<!--X-Reference: 56B13C96.9070706@noaa.gov -->
<!--X-Reference: 56B15353.4040707@csiro.au -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: [ferret_users] Compressed ferret output incompatibe with netcdf java apps</title>
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<HR>
<center>[<a href="msg00064.html">Thread Prev</a>][<a href="msg00082.html">Thread Next</a>][<A HREF="threads.html#00081">Index</A>]</center>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [ferret_users] Compressed ferret output incompatibe with netcdf java apps</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><strong>To</strong>: <strong><a href="mailto:ferret_users@DOMAIN.HIDDEN">ferret_users@xxxxxxxx</a></strong></li>
<li><strong>Subject</strong>: <strong>Re: [ferret_users] Compressed ferret output incompatibe with netcdf java apps</strong></li>
<li><strong>From</strong>: <strong>&quot;Ansley C. Manke&quot; &lt;<a href="mailto:ansley.b.manke@DOMAIN.HIDDEN">ansley.b.manke@xxxxxxxx</a>&gt;</strong></li>
<li>Date: Mon, 8 Feb 2016 15:32:38 -0800</li>
<li>Dkim-signature: v=1; a=rsa-sha256; c=relaxed/relaxed;        d=noaa-gov.20150623.gappssmtp.com; s=20150623;        h=subject:to:references:from:message-id:date:user-agent:mime-version         :in-reply-to:content-type:x-original-sender         :x-original-authentication-results:precedence:mailing-list:list-id         :list-post:list-help:list-archive:list-unsubscribe;        bh=bc3V5InPUv1hwiMOc0PAhDgHvbgJesKgSlWDMujSatk=;        b=OmMKwxsKhtSekXa8xYOqX2JOy7UED+heJv71wysYTrzXRqcQlfGdKApYHQ8F9O6c1k         pdhzyy9nUJfrqT640DTyQ8KyOu/zk8SLc+tZ7SIN6fHTRAT8C/r6VftdPuwO6sUMCYjO         73Wiyi7kvGu6ufzbenyAqovKZWyhchbGAxvpfBfkDPcWzwOsBn5lgK3IG+4Pxxc25C2V         L9EmsiNNcEyzR4xP3EAP70sRonCtgEjxTdo1++jAMacesE7waVOZaCKg5EjtxrnnWBd7         axU3UOxMld+ynxrlnAPU6lQEk0vY8lGK6LhHS3MVDEJf73XecJAKFeOpvCxJ24UhbkRS         5i2w==</li>
<li>In-reply-to: &lt;<a href="msg00064.html">56B15353.4040707@csiro.au</a>&gt;</li>
<li>List-archive: &lt;<a href="https://groups.google.com/a/noaa.gov/group/ferret_users/">https://groups.google.com/a/noaa.gov/group/ferret_users/</a>&gt;</li>
<li>List-help: &lt;<a href="https://support.google.com/a/noaa.gov/bin/topic.py?topic=25838">https://support.google.com/a/noaa.gov/bin/topic.py?topic=25838</a>&gt;, &lt;<a href="mailto:ferret_users+help@noaa.gov">mailto:ferret_users+help@noaa.gov</a>&gt;</li>
<li>List-id: &lt;ferret_users.noaa.gov&gt;</li>
<li>List-post: &lt;<a href="https://groups.google.com/a/noaa.gov/group/ferret_users/post">https://groups.google.com/a/noaa.gov/group/ferret_users/post</a>&gt;, &lt;<a href="mailto:ferret_users@noaa.gov">mailto:ferret_users@noaa.gov</a>&gt;</li>
<li>List-unsubscribe: &lt;<a href="mailto:googlegroups-manage+809428289204+unsubscribe@googlegroups.com">mailto:googlegroups-manage+809428289204+unsubscribe@googlegroups.com</a>&gt;, &lt;<a href="https://groups.google.com/a/noaa.gov/group/ferret_users/subscribe">https://groups.google.com/a/noaa.gov/group/ferret_users/subscribe</a>&gt;</li>
<li>Mailing-list: list <a href="mailto:ferret_users@DOMAIN.HIDDEN">ferret_users@xxxxxxxx</a>; contact <a href="mailto:ferret_users%2Bowners@DOMAIN.HIDDEN">ferret_users+owners@xxxxxxxx</a></li>
<li>References: &lt;alpine.LFD.2.10.1601191052420.1594@kelvin&gt; &lt;alpine.LFD.2.10.1601191158010.1594@kelvin&gt; &lt;<a href="msg00018.html">569E782B.709@noaa.gov</a>&gt; &lt;alpine.LFD.2.10.1601191444300.1594@kelvin&gt; &lt;<a href="msg00029.html">56A2C344.7090007@io-warnemuende.de</a>&gt; &lt;CAELLC7U_0XJ=L-N6jMrpk-2nQ-3+0pQAj_sbkD8ydrfJ+3RY4g@mail.gmail.com&gt; &lt;<a href="msg00045.html">56AB0C1F.5070702@csiro.au</a>&gt; &lt;<a href="msg00063.html">56B13C96.9070706@noaa.gov</a>&gt; &lt;<a href="msg00064.html">56B15353.4040707@csiro.au</a>&gt;</li>
<li>Sender: <a href="mailto:owner-ferret_users@DOMAIN.HIDDEN">owner-ferret_users@xxxxxxxx</a></li>
<li>User-agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:38.0) Gecko/20100101 Thunderbird/38.5.1</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<table width="100%"><tr><td bgcolor="#FFFFFF" style="background-color: #FFFFFF; color: #000000; "><font color="#000000">
  
  
    Hi Russ,<br>
    This looks to be an issue with the "fletcher32 checksum" setting in
    combination with the "shuffle" flag.&#xA0; We had implemented the default
    settings for netCDF-4 files following an example in some of the
    Unidata NetDCDF pages.<br>
    <br>
    That example also sets the "shuffle" flag to zero.&#xA0; In Ferret's
    implementation the shuffle flag is a variable, set by the user, but
    the fletcher32 checksum is always set.<br>
    <br>
    If I take out the call to <b>nc_def_var_fletcher32</b> or if I turn
    on the <b>shuffle </b>option, then I get files which Panoply can
    read. <br>
    <br>
    I can verify this behavior using the simple test programs that come
    as part of the NetCDF distribution, so it is not a result of how
    Ferret is linked with the netCDF libraries.&#xA0; I am making a report to
    Unidata. <br>
    <br>
    Meanwhile, when writing files using Ferret, I believe that using
    /SHUFFLE=1 will work consistently to give you files that netCDF java
    will read.<br>
    <br>
    Until we hear back from Unidata, I will leave the settings as they
    are in Ferret, except that if SHUFFLE is 0, then the call to set the
    fletcher32 checksum will not be made.<br>
    <br>
    <br>
    -Ansley<br>
    <br>
    <br>
    <div class="moz-cite-prefix">On 2/2/2016 5:09 PM, Russ Fiedler
      wrote:<br>
    </div>
    <blockquote cite="" type="cite">
      <br>
      Hi Ansley,
      <br>
      <br>
      I can confirm that turning on the shuffle option in ferret allows
      the variables to be read both in Panopoly and our in house
      software. Also passing unshuffled compressed files written by
      ferret through nccopy and explicity specifying the shuffle option
      works. However not specifying -s fails which is odd. Also taking
      an uncompressed file and passing it through nccopy works whether
      shuffling is specified or not. The command line version of nccopy
      definitely does not turn on shuffling by default. That just seems
      to be the case for the java version.
      <br>
      <br>
<a rel="nofollow" class="moz-txt-link-freetext" href="http://www.unidata.ucar.edu/software/netcdf/docs/netcdf_utilities_guide.html">http://www.unidata.ucar.edu/software/netcdf/docs/netcdf_utilities_guide.html</a>
      <br>
      <br>
      <br>
      Summarizing
      <br>
      <br>
      save/file=uncmp.nc/ncformat=netcdf4 var !works
      <br>
      save/file=cmp.nc/def/ncformat=netcdf4 var !fails&#xA0; no shuffling
      <br>
      save/file=cmp_shuff.nc/def/ncformat=netcdf4/shuff var&#xA0;&#xA0;&#xA0; !works
      <br>
      <br>
      Passing though nccopy
      <br>
      <br>
      nccopy -k4 -d1 cmp.nc&#xA0;&#xA0;&#xA0;&#xA0; cmp_nccopy_noshuff.nc&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; !
      still fails. No shuffling
      <br>
      nccopy -k4 -d1 -s cmp.nc&#xA0; cmp_nccopy_shuff.nc&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; !
      Now works with shuffling
      <br>
      nccopy -k4 -d1 uncmp.nc&#xA0; uncmp_nccopy_noshuff.nc&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; ! Now
      compressed, works but there's no shuffling!
      <br>
      nccopy -k4 -d1 -s uncmp.nc&#xA0; uncmp_nccopy_shuff.nc&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; ! Now
      compressed, works and is shuffled
      <br>
      <br>
      It definitely looks like something is being put in the file by
      Ferret that is causing grief. I looked at the Ferret source code
      and it all looks fine and mimicked the calls in a simple program
      which worked fine. My guess is that it may be something to do with
      the static compilation and other compilation options that may be
      causing the problem but I didn't get that far in my tests.
      <br>
      <br>
      We'll turn on the shuffle option now.
      <br>
      <br>
      Cheers,
      <br>
      Russ
      <br>
      <br>
      <br>
      On 03/02/16 10:32, Ansley C. Manke wrote:
      <br>
      <blockquote type="cite">Hi,
        <br>
        I experimented and found that if the file is written in Ferret
        using the qualifier /SHUFFLE=1 and deflation, then it seems to
        work correctly, at least in Panoply.
        <br>
        <br>
        In looking at some the netCDF documentation, I find this page
        that discusses the netcdf-java tools.
        <br>
        <a rel="nofollow" class="moz-txt-link-freetext" href="http://www.unidata.ucar.edu/software/thredds/current/netcdf-java/reference/manPages.html">http://www.unidata.ucar.edu/software/thredds/current/netcdf-java/reference/manPages.html</a>
        <br>
        <br>
        It says that shuffle=true is the default for nccopy.&#xA0; So that
        seems to be why running the file through nccopy causes it to
        work in the java-netCDF apps, and this may be what's meant by
        the "filter type =0" setting in the error message. Does this
        seem like a good solution to you Russ?
        <br>
        <br>
        Ansley
        <br>
        <br>
        On 1/28/2016 10:52 PM, Russ Fiedler wrote:
        <br>
        <blockquote type="cite">
          <br>
          <br>
          Hi,
          <br>
          <br>
          This is possibly a problem with netcdf java rather than ferret
          but anyway...
          <br>
          <br>
          If we make a variable and save it in compressed netcdf4 format
          it appears that java based netcdf software han't handle it.
          <br>
          <br>
          e.g.
          <br>
          <br>
          yes? let v=i[i=1:20]+j[j=1:20]
          <br>
          yes? save/file=cmp.nc/ncformat=netcdf4/def v&#xA0;&#xA0;&#xA0; ! compressed
          (actually it's larger but just an example)
          <br>
          yes? save/file=uncmp.nc/ncformat=netcdf4 v&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; ! uncompressed
          <br>
          <br>
          Now loading up in Panopoly (and another of our in house apps
          which is where we spotted the problem).When we try to operate
          on v
          <br>
          we get a message about an an unknown filter type being zero
          for the compressed version
          <br>
          <br>
          java.lang.RuntimeException: Unknown filter type=0
          <br>
          &#xA0;&#xA0;&#xA0; at
ucar.nc2.iosp.hdf5.H5tiledLayoutBB$DataChunk.getByteBuffer(H5tiledLayoutBB.java:198)<br>
          etc
          <br>
          <br>
          The uncompressed version is fine since there are no filters
          being applied.
          <br>
          <br>
          Now, here's where it gets weird. If nccopy is used to convert
          the two files to compressed netcdf4 style the originally
          compressed file is
          <br>
          still giving Panopoly grief but the newly compress file is
          handled just fine!
          <br>
          <br>
          <br>
          xwing-hf% nccopy -k 3 -d 1 cmp.nc cmp_ncopy.nc&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; !
          Still no good
          <br>
          xwing-hf% nccopy -k 3 -d 1 uncmp.nc uncmp_ncopy.nc&#xA0; !
          compressed file is fine!!!
          <br>
          <br>
          Any clues? A known issue?
          <br>
          <br>
          Occurs for V6.95, V6.96 and earlier by the looks.
          <br>
          <br>
          Cheers,
          <br>
          Russ
          <br>
          <br>
          <br>
          <br>
          <br>
          <br>
          <br>
          <br>
          <br>
          <br>
        </blockquote>
        <br>
      </blockquote>
      <br>
    </blockquote>
    <br>
  

</font></td></tr></table>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="00082" href="msg00082.html">Re: [ferret_users] Compressed ferret output incompatibe with netcdf java apps</a></strong>
<ul><li><em>From:</em> Russ Fiedler</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00016" href="msg00016.html">[ferret_users] question about binary file writing in ferret: doubling of size with repeat</a></strong>
<ul><li><em>From:</em> Lev Tarasov</li></ul></li>
<li><strong><a name="00017" href="msg00017.html">[ferret_users] binary file output is garbled Re: question about binary file writing in ferret: doubling of size with repeat</a></strong>
<ul><li><em>From:</em> Lev Tarasov</li></ul></li>
<li><strong><a name="00018" href="msg00018.html">Re: [ferret_users] binary file output is garbled Re: question about binary file writing in ferret: doubling of size with repeat</a></strong>
<ul><li><em>From:</em> Ansley C. Manke</li></ul></li>
<li><strong><a name="00019" href="msg00019.html">Re: [ferret_users] binary file output is garbled Re: question about binary file writing in ferret: doubling of size with repeat</a></strong>
<ul><li><em>From:</em> Lev Tarasov</li></ul></li>
<li><strong><a name="00029" href="msg00029.html">[ferret_users] ferret_users: eps-figures produced with pyferret become rotated</a></strong>
<ul><li><em>From:</em> Martin Schmidt</li></ul></li>
<li><strong><a name="00031" href="msg00031.html">Re: [ferret_users] ferret_users: eps-figures produced with pyferret become rotated</a></strong>
<ul><li><em>From:</em> Karl Smith - NOAA Affiliate</li></ul></li>
<li><strong><a name="00045" href="msg00045.html">[ferret_users] Compressed ferret output incompatibe with netcdf java apps</a></strong>
<ul><li><em>From:</em> Russ Fiedler</li></ul></li>
<li><strong><a name="00063" href="msg00063.html">Re: [ferret_users] Compressed ferret output incompatibe with netcdf java apps</a></strong>
<ul><li><em>From:</em> Ansley C. Manke</li></ul></li>
<li><strong><a name="00064" href="msg00064.html">Re: [ferret_users] Compressed ferret output incompatibe with netcdf java apps</a></strong>
<ul><li><em>From:</em> Russ Fiedler</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<UL>
<li>Previous by thread:
<strong><a href="msg00064.html">Re: [ferret_users] Compressed ferret output incompatibe with netcdf java apps</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00082.html">Re: [ferret_users] Compressed ferret output incompatibe with netcdf java apps</a></strong>
</li>

</UL>
<center>[<a href="msg00064.html">Thread Prev</a>][<a href="msg00082.html">Thread Next</a>][<A HREF="threads.html#00081">Index</A>]</center>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<A HREF="http://ferret.pmel.noaa.gov/Ferret/contact-us">Contact Us</A>
<br>
<font size=-1>
<address>
<a href="http://www.doc.gov">Dept of Commerce</a> /
<a href="http://www.noaa.gov">NOAA</a> /
<a href="http://www.oar.noaa.gov">OAR</a> /
<a href="http://www.pmel.noaa.gov">PMEL</a> /
<a href="http://ferret.pmel.noaa.gov">Ferret</a>
</address>

<br>
 <a href="http://www.noaa.gov/privacy.html">Privacy Policy</a> | <a href="http://www.noaa.gov/disclaimer.html">Disclaimer</a> | <a href="accessibility.html">Accessibility Statement</a> 

</font>
<!--X-User-Footer-End-->
</body>
</html>
