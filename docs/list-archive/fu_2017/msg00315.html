<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: [ferret_users] pyferret crash while storing large dataset &#45; alternatives to prepare an ensemble? -->
<!--X-From-R13: "Dvrqr, Vryyn" <uryyn.evrqrNzcvp.qr> -->
<!--X-Date: Fri, 28 Apr 2017 01:12:28 &#45;0700 -->
<!--X-Message-Id: 5ce3f564d6284796a083d3071f847880@mpic.de -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: cf5668f33b2f4a9eb9cc4a23e086fbea@mpic.de -->
<!--X-Reference: CAELLC7UaEJn8J1&#45;EmTCPB5a6baiW4N2L4JrPE+zAjyPqvPks1A@mail.gmail.com -->
<!--X-Reference: ee25012bd81149868b4077d15e6b5bd8@mpic.de -->
<!--X-Reference: CAJb4+dytRoSW_uQLY6XooT44xMarVXmcnxobr5&#45;nBZmhdG=ZVA@mail.gmail.com -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: [ferret_users] pyferret crash while storing large dataset - alternatives to prepare an ensemble?</title>
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<HR>
<center>[<a href="msg00312.html">Thread Prev</a>][<a href="msg00313.html">Thread Next</a>][<A HREF="threads.html#00315">Index</A>]</center>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [ferret_users] pyferret crash while storing large dataset - alternatives to prepare an ensemble?</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><strong>To</strong>: <strong>Ansley Manke - NOAA Federal &lt;<a href="mailto:ansley.b.manke@DOMAIN.HIDDEN">ansley.b.manke@xxxxxxxx</a>&gt;</strong></li>
<li><strong>Subject</strong>: <strong>Re: [ferret_users] pyferret crash while storing large dataset - alternatives to prepare an ensemble?</strong></li>
<li><strong>From</strong>: <strong>&quot;Riede, Hella&quot; &lt;<a href="mailto:hella.riede@DOMAIN.HIDDEN">hella.riede@xxxxxxx</a>&gt;</strong></li>
<li>Date: Fri, 28 Apr 2017 08:12:24 +0000</li>
<li>Accept-language: en-US, de-DE</li>
<li>Cc: ferret users &lt;<a href="mailto:ferret_users@DOMAIN.HIDDEN">ferret_users@xxxxxxxx</a>&gt;</li>
<li>Dkim-signature: v=1; a=rsa-sha256; c=relaxed/relaxed;        d=noaa-gov.20150623.gappssmtp.com; s=20150623;        h=from:to:cc:subject:thread-topic:thread-index:date:message-id         :references:in-reply-to:accept-language:content-language         :content-transfer-encoding:mime-version:x-original-sender         :x-original-authentication-results:precedence:mailing-list:list-id         :list-post:list-help:list-archive:list-unsubscribe;        bh=S2jwCR5a5c7d88BZofO7M8BoIo6Z688VmkYZ2WdCaIo=;        b=VQQv31UpI0LHjO7t9amex10KlaQ2B+dedD1Kd0n2XLQdr0Ic/uqww2bJ4GSY7Pd17F         l1X2Qd0x0CS4WMlGDlsDwlaVHERoU0Pzp1SBBAjct40gqhdvELsooWgWyXBFfeS9c7mR         CXQytfRFx2eMWhONH8jumA+p/kMgCmN+oA9OVjTnJX/j7wp7Zo445R01W9an0c3y15xQ         hzSw+TbE0kJnFCB2B50LQYp/Z1plQRu+B2asas6wnMjg9StGv41hAxfH1+UDgpMCsDSf         LoKjIOPVPyu+pl+uDbJ1JWZvnpCfY2LQf06XKrUXGt3rIlEpteGRu17SZc9KcObuYE2v         j40w==</li>
<li>In-reply-to: &lt;CAJb4+dytRoSW_uQLY6XooT44xMarVXmcnxobr5-nBZmhdG=ZVA@mail.gmail.com&gt;</li>
<li>List-archive: &lt;<a href="https://groups.google.com/a/noaa.gov/group/ferret_users/">https://groups.google.com/a/noaa.gov/group/ferret_users/</a>&gt;</li>
<li>List-help: &lt;<a href="https://support.google.com/a/noaa.gov/bin/topic.py?topic=25838">https://support.google.com/a/noaa.gov/bin/topic.py?topic=25838</a>&gt;, &lt;<a href="mailto:ferret_users+help@noaa.gov">mailto:ferret_users+help@noaa.gov</a>&gt;</li>
<li>List-id: &lt;ferret_users.noaa.gov&gt;</li>
<li>List-post: &lt;<a href="https://groups.google.com/a/noaa.gov/group/ferret_users/post">https://groups.google.com/a/noaa.gov/group/ferret_users/post</a>&gt;, &lt;<a href="mailto:ferret_users@noaa.gov">mailto:ferret_users@noaa.gov</a>&gt;</li>
<li>List-unsubscribe: &lt;<a href="mailto:googlegroups-manage+809428289204+unsubscribe@googlegroups.com">mailto:googlegroups-manage+809428289204+unsubscribe@googlegroups.com</a>&gt;, &lt;<a href="https://groups.google.com/a/noaa.gov/group/ferret_users/subscribe">https://groups.google.com/a/noaa.gov/group/ferret_users/subscribe</a>&gt;</li>
<li>Mailing-list: list <a href="mailto:ferret_users@DOMAIN.HIDDEN">ferret_users@xxxxxxxx</a>; contact <a href="mailto:ferret_users%2Bowners@DOMAIN.HIDDEN">ferret_users+owners@xxxxxxxx</a></li>
<li>References: &lt;<a href="msg00305.html">cf5668f33b2f4a9eb9cc4a23e086fbea@mpic.de</a>&gt; &lt;<a href="msg00307.html">CAELLC7UaEJn8J1-EmTCPB5a6baiW4N2L4JrPE+zAjyPqvPks1A@mail.gmail.com</a>&gt; &lt;<a href="msg00308.html">ee25012bd81149868b4077d15e6b5bd8@mpic.de</a>&gt;,&lt;CAJb4+dytRoSW_uQLY6XooT44xMarVXmcnxobr5-nBZmhdG=ZVA@mail.gmail.com&gt;</li>
<li>Sender: <a href="mailto:owner-ferret_users@DOMAIN.HIDDEN">owner-ferret_users@xxxxxxxx</a></li>
<li>Thread-index: AQHSvuy1i0fY1xkLH0+HdD5JDEFOfqHYTEGAgADXsC2AAAa/AIABQrKN</li>
<li>Thread-topic: [ferret_users] pyferret crash while storing large dataset - alternatives to prepare an ensemble?</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Hi Ansley and list,

exactly, DEFINE DATA, ncecat and other methods to make an ensemble are only the next step and probably quite straightforward. My issue was with preparing the data for that step by unifying grids. I do have shorter time axes already, and a ragged array in E. As described below, I prepare the data to be an ensemble with ferret in the following way:

1) read in a dataset
2) define long common axes for T and E that will be shared by all files
3) loop over all variables in the files using the file attribute ..varnames (variable names are the same in all files)
4) write out all variables on the new common T and E axes

I did not find a simpler way to &quot;extend&quot; grids, e.g., adding a certain number of undefined data points along the axis E of an existing file.

The error message I previously got was cryptic to me, but with the ideas below and 'set memory/size=10000' it worked out fine.


Thanks,
Hella



________________________________________
From: Ansley Manke - NOAA Federal &lt;ansley.b.manke@xxxxxxxx&gt;
Sent: Thursday, April 27, 2017 16:46
To: Riede, Hella
Cc: ferret users
Subject: Re: [ferret_users] pyferret crash while storing large dataset - alternatives to prepare an ensemble?

Hella,
You might try an experiment or two, perhaps making a much shorter common time axis and doing the commands without the netCDF compression, to see if that might be related to the crash.  I'm not aware of any problems with that in the netCDF4 calls, but that might be worth checking.

The &quot;DEFINE DATA&quot; aggregations on the fly would want to create an ensemble by defining an E axis and treating the ensemble members as a list on that new axis.  Since your data have an E axis already, in order to use that you'd need to perhaps open your datasets with and force the data onto another grid, maybe with USE/ORDER=TF  - but as you say the variables are not coming in on the same grid so this probably doesn't quite fit.

Ansley

On Thu, Apr 27, 2017 at 8:24 AM, Riede, Hella &lt;hella.riede@xxxxxxx&lt;<a  rel="nofollow" href="mailto:hella.riede@xxxxxxx">mailto:hella.riede@xxxxxxx</a>&gt;&gt; wrote:
Hi Karl,

thanks for your idea. As to the aggregate command, this only works for &quot;those variables from the datasets that have identical variable names and grids.&quot;. I do have identical variable names in all files, but not identical grids yet.

I try exactly this: to prepare the datasets to become an ensemble by giving them identical grids, but at the moment they have a ragged array in E, and only partial overlap in T.


Best wishes,
Hella

________________________________________
From: Karl Smith - NOAA Affiliate &lt;karl.smith@xxxxxxxx&lt;<a  rel="nofollow" href="mailto:karl.smith@xxxxxxxx">mailto:karl.smith@xxxxxxxx</a>&gt;&gt;
Sent: Thursday, April 27, 2017 3:30:13 AM
To: Riede, Hella
Cc: ferret users
Subject: Re: [ferret_users] pyferret crash while storing large dataset - alternatives to prepare an ensemble?

Hi Hella,

The cryptic error message is showing the (last) line in the 'pyferret' shell script making the call to run PyFerret in Python.  So yes, not meaningful and wishing there was more output indicating what the actual problem is and where it is coming from.

As for aggregating your datasets, have you tried the define data /aggregate command?

<a  rel="nofollow" href="http://ferret.pmel.noaa.gov/Ferret/documentation/users-guide/commands-reference/DEFINE#_define_data">http://ferret.pmel.noaa.gov/Ferret/documentation/users-guide/commands-reference/DEFINE#_define_data</a>

I must admit I did not look closely enough at what you had to see if one of the options would work.

Karl


On Wed, Apr 26, 2017 at 8:25 PM, Riede, Hella &lt;hella.riede@xxxxxxx&lt;<a  rel="nofollow" href="mailto:hella.riede@xxxxxxx">mailto:hella.riede@xxxxxxx</a>&gt;&lt;<a  rel="nofollow" href="mailto:hella.riede@xxxxxxx">mailto:hella.riede@xxxxxxx</a>&lt;<a  rel="nofollow" href="mailto:hella.riede@xxxxxxx">mailto:hella.riede@xxxxxxx</a>&gt;&gt;&gt; wrote:
Hello ferreters,

I am storing a large dataset, looping over variables. The main line for that is
save/quiet/file=($out)/NCFORMAT=4/DEFLATE=4/append ($var);\

After the file has grown to 713 MB, the script crashes with the following error message:

/afs/ipp/.cs/python_modules/amd64_generic/pyferret/anaconda/2/4.1.1/bin/ferret: line 17: 40827 Killed                  python ${python_flags} -c &quot;import sys; import pyferret; (errval, errmsg) = pyferret.init(sys.argv[1:], True)&quot; &quot;$@&quot;

Same happens when using DEFLATE=1 instead as recommended.

This is quite cryptic to me - can anybody help?



*Background* (Maybe there's another more efficient way?)

I have about 80 large netCDF files with 2 dimensions - time and E. The times overlap partially and cover altogether about 3 years. The E dimension has different lengths. I'd like to combine those datasets into an ensemble / one file, for instance along F.

To combine the data as an ensemble, I have to unify the existing dimensions first, so I
1) read in a dataset
2) define the unified axes for T and E
3) loop over all variables in the files (they are the same in all files)
4) write out all variables on the new T and E axes.

After having written 713 MB of the new file, which corresponds to 31 of the 115 variables, the above error occurs. There's no special issues with the variable where it happens, no non-standard name.


An other method I have tried: Enlarge the E dimension by producing an empty hyperslab and glueing this onto the original dataset via ncrcat. This is impossibly slow.


Any other way to efficiently fill a file with undefined values to make them ready for being an ensemble?


Thanks in advance!

Hella





--
Karl M. Smith, Ph.D.
JISAO Univ. Wash. and PMEL NOAA
&quot;The contents of this message are mine personally and do
not necessarily reflect any position of the Government
or the National Oceanic and Atmospheric Administration.&quot;




</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="00305" href="msg00305.html">[ferret_users] pyferret crash while storing large dataset - alternatives to prepare an ensemble?</a></strong>
<ul><li><em>From:</em> Riede, Hella</li></ul></li>
<li><strong><a name="00307" href="msg00307.html">Re: [ferret_users] pyferret crash while storing large dataset - alternatives to prepare an ensemble?</a></strong>
<ul><li><em>From:</em> Karl Smith - NOAA Affiliate</li></ul></li>
<li><strong><a name="00308" href="msg00308.html">Re: [ferret_users] pyferret crash while storing large dataset - alternatives to prepare an ensemble?</a></strong>
<ul><li><em>From:</em> Riede, Hella</li></ul></li>
<li><strong><a name="00312" href="msg00312.html">Re: [ferret_users] pyferret crash while storing large dataset - alternatives to prepare an ensemble?</a></strong>
<ul><li><em>From:</em> Ansley Manke - NOAA Federal</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<UL>
<li>Previous by thread:
<strong><a href="msg00312.html">Re: [ferret_users] pyferret crash while storing large dataset - alternatives to prepare an ensemble?</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg00313.html">[ferret_users] Need a help for plotting ship tracks</a></strong>
</li>

</UL>
<center>[<a href="msg00312.html">Thread Prev</a>][<a href="msg00313.html">Thread Next</a>][<A HREF="threads.html#00315">Index</A>]</center>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<A HREF="http://ferret.pmel.noaa.gov/Ferret/contact-us">Contact Us</A>
<br>
<font size=-1>
<address>
<a href="http://www.doc.gov">Dept of Commerce</a> /
<a href="http://www.noaa.gov">NOAA</a> /
<a href="http://www.oar.noaa.gov">OAR</a> /
<a href="http://www.pmel.noaa.gov">PMEL</a> /
<a href="http://ferret.pmel.noaa.gov">Ferret</a>
</address>

<br>
 <a href="http://www.noaa.gov/privacy.html">Privacy Policy</a> | <a href="http://www.noaa.gov/disclaimer.html">Disclaimer</a> | <a href="accessibility.html">Accessibility Statement</a> 

</font>
<!--X-User-Footer-End-->
</body>
</html>
