<!-- MHonArc v2.6.18 -->
<!--X-Subject: [ferret_users] dynamic_height.jnl (and @iin, @rsum in general) -->
<!--X-From-R13: Ivyyvnz Yrffyre &#45; @AOO Trqreny <jvyyvnz.f.xrffyreNabnn.tbi> -->
<!--X-Date: Sat, 5 Feb 2022 11:38:44 &#45;0800 -->
<!--X-Message-Id: CAK0Qe2OH&#45;O&#45;ezGndAMFVT0sGRHZPnMjZ7mvfs9NjjFq9DaXJaA@mail.gmail.com -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Derived: pngebhiffDopv.png -->
<!--X-Derived: binK9Bm7Gautv.bin -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>[ferret_users] dynamic_height.jnl (and @iin, @rsum in general)</title>
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<HR>
<center>[<a href="msg01078.html">Thread Prev</a>][<a href="msg01089.html">Thread Next</a>][<A HREF="threads.html#01088">Index</A>]</center>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>[ferret_users] dynamic_height.jnl (and @iin, @rsum in general)</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><strong>To</strong>: <strong>Ferret &lt;<a href="mailto:ferret_users@DOMAIN.HIDDEN">ferret_users@xxxxxxxx</a>&gt;,        William Kessler - NOAA Federal &lt;<a href="mailto:william.s.kessler@DOMAIN.HIDDEN">william.s.kessler@xxxxxxxx</a>&gt;</strong></li>
<li><strong>Subject</strong>: <strong>[ferret_users] dynamic_height.jnl (and @iin, @rsum in general)</strong></li>
<li><strong>From</strong>: <strong>William Kessler - NOAA Federal &lt;<a href="mailto:william.s.kessler@DOMAIN.HIDDEN">william.s.kessler@xxxxxxxx</a>&gt;</strong></li>
<li>Date: Sat, 5 Feb 2022 11:38:30 -0800</li>
<li>Arc-authentication-results: i=2; mx.google.com;       dkim=pass header.i=@noaa.gov header.s=google header.b=&quot;RDRh7e/g&quot;;       spf=pass (google.com: domain of <a href="mailto:william.s.kessler@DOMAIN.HIDDEN">william.s.kessler@xxxxxxxx</a> designates 209.85.220.41 as permitted sender) smtp.mailfrom=<a href="mailto:william.s.kessler@DOMAIN.HIDDEN">william.s.kessler@xxxxxxxx</a>;       dmarc=pass (p=REJECT sp=REJECT dis=NONE) header.from=noaa.gov</li>
<li>Arc-authentication-results: i=1; mx.google.com;       dkim=pass header.i=@noaa.gov header.s=google header.b=&quot;RDRh7e/g&quot;;       spf=pass (google.com: domain of <a href="mailto:william.s.kessler@DOMAIN.HIDDEN">william.s.kessler@xxxxxxxx</a> designates 209.85.220.41 as permitted sender) smtp.mailfrom=<a href="mailto:william.s.kessler@DOMAIN.HIDDEN">william.s.kessler@xxxxxxxx</a>;       dmarc=pass (p=REJECT sp=REJECT dis=NONE) header.from=noaa.gov</li>
<li>Arc-message-signature: i=2; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;        h=list-archive:list-help:list-post:list-id:mailing-list:precedence:to         :subject:message-id:date:from:mime-version:dkim-signature;        bh=kIGj9hfKmhMBR66AEE5ciisZOQNXSJ9IWPinH36Bj/0=;        b=s4LVTSPBjhDq6Cy+HIsxHxuXqJ4RJX5nNQg9RaGCrgXhUOQUcugnP/x+KYFPfe3PkX         xFITtLncaWThQT56KN4AY8yL5DHua/nswQ6dAJXwpVLU4EHguM2B6bb7RHGKbDVXSaXg         KxXKMdIqnOFgnA79833lKuVOtNZKZvRrIfy7Hf16kwS53634evZe5a4lJp3+/Iv5NXTd         neTrnAX2bJk3EoMChaurN17eKKlHDRaAdoUJhjUtZFZZexq0icWBz/TV11Sce+/OrXy2         iD+mvoEmOx3M9XT9/U95gD5QMfU342JSQMxzBVGJ0ZNb3Gl1wsMEDXhmpuw+Uq/4NBwd         Lyrg==</li>
<li>Arc-message-signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;        h=to:subject:message-id:date:from:mime-version:dkim-signature;        bh=kIGj9hfKmhMBR66AEE5ciisZOQNXSJ9IWPinH36Bj/0=;        b=KMqSPO0FhnN1C39AcP/MV6mZn/yTekJBCpTCAevM+e9yxJbmeuFMiYVAxjV5qNOzGx         b5bah9Nh3aCdn2I4gU8/jPnOWTfG833u/WVOts3jjZXinguKRqnoLa7J5xTt7ayEn9ns         WirsbKEFc4uPHY+UumRWqonLeKDukLXTkWLGg8H4IWDg//TcmltfdkUrPggeU/L8Jlrb         JwuE9dMENSorS7gEIRMxxCZja9Lfw0zDJST15SnGnEQgROcENhFHjVeH6CoMqpUqZErQ         MuDtrWRJpY/gO0F01IV+qiAeJAXdUNhOEuxcGoABW02EUFJkFsCvmflfQBcUghEfeLeq         udoQ==</li>
<li>Arc-seal: i=2; a=rsa-sha256; t=1644089923; cv=pass;        d=google.com; s=arc-20160816;        b=lv70th6Ufgf1PrEo6xMIvZtrdIi2DM57b+0svltd5S8XYKQwZ/qGNiaW9pdCMxyObt         I6mCJpkKaZKXIMPpUvcqDl241Cg8CUa4DRIrMi/++WocnXSGkb/SvRRPweiFd6gGzfCd         hKMLUYsEVpmIWwj4a072FslcFY7bqaYjctambM0S3J6QA+Hsr4o2/qmH7pW58l/sDIfs         eG8JPduBvGD7M5RxmyO7R2RrO+e0iOEap63F5ChjZSuaQI+aawMFEjHY2CbkAxZmVrGa         eKunSLgx8eW0KrRiT2Uq+nq6XbodUfjs7/AOPC3DoJwP5BjNscH29AegbHrBBCSMp3Mb         CpIw==</li>
<li>Arc-seal: i=1; a=rsa-sha256; t=1644089922; cv=none;        d=google.com; s=arc-20160816;        b=rBtCMdIYT1XMaUIpByGLVDBXnH50u1YWhAoDx7LbNinQ6h7I1Jjgv57HlBkbD/2Ahh         nDwzu8hVPcml9zVhhrpNCWSbjN1Hr9Nkb6bi1LtqoeYIwfjQRSRP3k1s19tjGym2hMog         XGECxb3HNJeunvwOedy1FUxYfazHawLzgtX6qsCPby0HVPjIuB7QXyRqXmlzd7oCg6Iv         fc7O54l8m2fcZRzR9zkgqf+CH/+Y//tJIMx+h++75K+aw3t3Sc+psWRR9g7YMviit8Ct         cdCIjiVluBmj0D9SwKqPKFtotrnqW89R1X9IrDbZfnlUa8RQneUBuJcjSHYQXNNLDPwJ         zEmg==</li>
<li>Dkim-signature: v=1; a=rsa-sha256; c=relaxed/relaxed;        d=noaa.gov; s=google;        h=mime-version:from:date:message-id:subject:to:x-original-sender         :x-original-authentication-results:precedence:mailing-list:list-id         :list-post:list-help:list-archive;        bh=kIGj9hfKmhMBR66AEE5ciisZOQNXSJ9IWPinH36Bj/0=;        b=KTboQ0Db/wzOQkMRbMuIeJhfSoNP7mpH2ukayE118AlMTNl05Krc0SHMR5ybdfMDHi         uB18IV6f8bFoZkwfF4hNc8vpY365N5buROU/L5997hfhTfBc1+N2mUpAZ1cN7/ln4AJM         w0zWbv7+zoLNPsd0sLlNc8So9XOS0l9PBavbA+owohCStshlCGqi1s/moP5sRuzMq2/s         T9sW0WUQxlxNQA/quzcGQMWwPkbpjzi/hFqj4+7cWVUATzsfvGf7nkNijQg1mieQbOOM         tWo3KqDuhIrgbcgIPCNNsEtFXFK3zZ5hT7S8XPELBfM6+MOq1dMQ/BvciQuvrcmgCcR1         dO5A==</li>
<li>List-archive: &lt;<a href="https://groups.google.com/a/noaa.gov/group/ferret_users/">https://groups.google.com/a/noaa.gov/group/ferret_users/</a>&gt;</li>
<li>List-help: &lt;<a href="https://support.google.com/a/noaa.gov/bin/topic.py?topic=25838">https://support.google.com/a/noaa.gov/bin/topic.py?topic=25838</a>&gt;, &lt;<a href="mailto:ferret_users+help@noaa.gov">mailto:ferret_users+help@noaa.gov</a>&gt;</li>
<li>List-id: &lt;ferret_users.noaa.gov&gt;</li>
<li>List-post: &lt;<a href="https://groups.google.com/a/noaa.gov/group/ferret_users/post">https://groups.google.com/a/noaa.gov/group/ferret_users/post</a>&gt;, &lt;<a href="mailto:ferret_users@noaa.gov">mailto:ferret_users@noaa.gov</a>&gt;</li>
<li>Mailing-list: list <a href="mailto:ferret_users@DOMAIN.HIDDEN">ferret_users@xxxxxxxx</a>; contact <a href="mailto:ferret_users%2Bowners@DOMAIN.HIDDEN">ferret_users+owners@xxxxxxxx</a></li>
<li>Sender: <a href="mailto:owner-ferret_users@DOMAIN.HIDDEN">owner-ferret_users@xxxxxxxx</a></li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<div dir="ltr">Hi Ferreters -<br><br>I happened to look at our standard dynamic height script today. <br>(On my system it is .../opt/miniconda3/pkgs/pyferret-7.6.3-py37hfb0c5.1/go/dynamic_height.jnl) <br><div>(comments say &quot;updated in 10/93&quot; ... before some of you were even born ...)</div><div>(the script is also attached FYI)<br></div><br>I think there&#39;s a subtle error in this script, due to the upward indefinite integral. <br>Beyond dynamic height, the issue occurs anytime where @iin (or @rsum) is used.<br><br>The relevant parts of the dynamic_height.jnl algorithm are:<br><br>! Standard _expression_ for specific volume anomaly <br>let SVanom = 1/rho_UN(dyn_s,dyn_t,dyn_p) - 1/rho_UN(35,0,dyn_p) &#xA0;! dyn_[s,t,p] are temp,salinity,pressure<br><br>! The _expression_ for the top-to-bottom integral is straightforward:<br>let/title=&quot;Dynamic Height(dyn-cm)&quot; DYN_HT &#xA0;= 1E5 * dyn_mask * SVanom[z=@din] &#xA0; ! (dyn_mask excludes incomplete profiles)<br><br>! But for a z-dependent result, the direction of the z-axis and of integration must be considered.<br>! The z-axis is typically DOWNWARD (/DEPTH in the axis definition), but the intended integration is UPWARD.<br>! Thus the indefinite integral @iin needs to be reversed using @din minus @iin. <br>! In the script this is:<br><br>let/title=&quot;Dynamic Height(dyn-cm)&quot; DYN_HTz = 1E5 * dyn_mask * (SVanom[z=@din]-SVanom[z=@iin])<br><br>! However, the user probably expects the value to be at the same depths as the density data, namely at the center of each grid cell.<br><br>! But the script&#39;s _expression_ integrates completely through each grid cell, giving the value of the integral at the TOP of the cell.<br><br>! - - - - - - - - -<br>! A simple way to see what&#39;s happening is with a simple example of the results of @din - @iin, defining an example that can be followed in your head:<br><br>define axis/z/depth zdep={1,2,3,4,5} &#xA0; &#xA0; &#xA0; ! simple downward z-axis<br>let zvals = 2*z[gz=zdep] &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; ! variable on this axis with values twice the axis value<br><br><div>! plot ZVALS, its downward integral and two versions of its upward integral (attached png file)</div><div>! (also include a downward @iin integration: red and brown lines)<br></div>plot/line/sym=27/thick=2/vli=0:5.5/hli=0:31:5 &#xA0;zvals,zvals[z=@iin],zvals[z=@din]-zvals[z=@iin],zvals[z=@din]-(zvals[z=@iin]-zvals*zbox/2),zvals[z=@iin]-zvals*zbox/2<br><br><div>! list the relevant pieces, including the grid cell size and limits:</div>list z[gz=zdep],zbox[gz=zdep],zboxlo[gz=zdep],zboxhi[gz=zdep],zvals,zvals[z=@iin],zvals[z=@din]-zvals[z=@iin],zvals[z=@din]-(zvals[z=@iin]-zvals*zbox/2),zvals[z=@iin]-zvals*zbox/2<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;Z: 0.5 to 5.5<br>&#xA0;Column &#xA0;1: Z is Z (axis ZDEP)<br>&#xA0;Column &#xA0;2: ZBOX is ZBOX (axis ZDEP)<br>&#xA0;Column &#xA0;3: ZBOXLO is ZBOXLO (axis ZDEP)<br>&#xA0;Column &#xA0;4: ZBOXHI is ZBOXHI (axis ZDEP)<br>&#xA0;Column &#xA0;5: ZVALS is 2*Z[GZ=ZDEP]<br>&#xA0;Column &#xA0;6: ZVALS[Z=@IIN] is 2*Z[GZ=ZDEP] (indef. integ. on Z)&#xA0;&#xA0; ! simple downward @iin<br>&#xA0;Column &#xA0;7: EX#7 is ZVALS[Z=@DIN]-ZVALS[Z=@IIN]&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; ! integration as in dynamic_height.jnl<br>&#xA0;Column &#xA0;8: EX#8 is ZVALS[Z=@DIN]-(ZVALS[Z=@IIN]-ZVALS*ZBOX/2)&#xA0;&#xA0; ! I think this is correct for DH<br>&#xA0;Column &#xA0;9: EX#9 is ZVALS[Z=@IIN]-ZVALS*ZBOX/2&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; ! correct downward integration<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;Z &#xA0; ZBOX &#xA0;ZBOXLO ZBOXHI &#xA0;ZVALS &#xA0;ZVALS &#xA0;EX#7 &#xA0; EX#8 &#xA0; EX#9<br>1 &#xA0; / 1: &#xA0;1.000 &#xA0;1.000 &#xA0;0.500 &#xA0;1.500 &#xA0; 2.00 &#xA0; 2.00 &#xA0;28.00 &#xA0;29.00 &#xA0; 1.00<br>2 &#xA0; / 2: &#xA0;2.000 &#xA0;1.000 &#xA0;1.500 &#xA0;2.500 &#xA0; 4.00 &#xA0; 6.00 &#xA0;24.00 &#xA0;26.00 &#xA0; 4.00<br>3 &#xA0; / 3: &#xA0;3.000 &#xA0;1.000 &#xA0;2.500 &#xA0;3.500 &#xA0; 6.00 &#xA0;12.00 &#xA0;18.00 &#xA0;21.00 &#xA0; 9.00<br>4 &#xA0; / 4: &#xA0;4.000 &#xA0;1.000 &#xA0;3.500 &#xA0;4.500 &#xA0; 8.00 &#xA0;20.00 &#xA0;10.00 &#xA0;14.00 &#xA0;16.00<br>5 &#xA0; / 5: &#xA0;5.000 &#xA0;1.000 &#xA0;4.500 &#xA0;5.500 &#xA0;10.00 &#xA0;30.00 &#xA0; 0.00 &#xA0; 5.00 &#xA0;25.00<br><br>We&#39;re comparing EX#7 (as in dynamic_height.jnl, green line on plot) and EX#8 (I think is correct, blue line).<br>Which is correct?<br><br>The issue is that the value of the integral is understood as being at the grid cell centers.<br><br>Starting at a value of 30 at the bottom of the deepest cell (z=5.5), the first value is halfway up that cell, thus half of ZVALS[z=5], namely 5. An _expression_ like in dynamic_height.jnl gives 0. <br><br>Following the blue line, the value of the integral at the highest gridcell (z=1) is 29 (not 30 because this integration is not to the top of the cell at z=0.5). Nor is is 28, which is what an integration like in dynamic_height.jnl would give. <br>! - - - - - - - - -<br><br>Thus I think the correct _expression_ for the dynamic height integration should be like EX#8:<br><br>let/title=&quot;Dynamic Height(dyn-cm)&quot; DYN_HTz = 1E5 * dyn_mask * (SVanom[z=@din]-(SVanom[z=@iin]-SVanom*ZBOX/2))<br><br>The same issue occurs in any @iin integration. <br>Consider the red line in the attached plot (ZVALS[z=@iin], EX#9 in the listing above). <br>At the first grid cell (z=1) the value is 2, the whole value of ZVALS[k=1], as if the integration had been carried through the whole cell (thus to z=1.5).<br><br>A corrected version is the brown line: zvals[z=@iin]-zvals*zbox/2, namely to the center of each cell.<br><br>=&gt; Bottom line is that the results of @iin and @rsum need to be considered with care. <br><div>&#xA0; &#xA0;Where exactly do you expect the result to apply?</div><div><br></div><div>Billy K<br></div><div><br></div><div><br></div><div><br></div><div><img src="pngebhiffDopv.png" alt="zvals_test2.png" width="558" height="482"><br><br></div></div>
<p><strong>Attachment:
<a href="binK9Bm7Gautv.bin" ><tt>dynamic_height.jnl</tt></a></strong><br>
<em>Description:</em> Binary data</p>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="01089" href="msg01089.html">Re: [ferret_users] dynamic_height.jnl (and @iin, @rsum in general)</a></strong>
<ul><li><em>From:</em> Andrew Wittenberg - NOAA Federal</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<UL>
<li>Previous by thread:
<strong><a href="msg01078.html">[ferret_users] how to map date strings from a csv file onto a ferret time axis</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg01089.html">Re: [ferret_users] dynamic_height.jnl (and @iin, @rsum in general)</a></strong>
</li>

</UL>
<center>[<a href="msg01078.html">Thread Prev</a>][<a href="msg01089.html">Thread Next</a>][<A HREF="threads.html#01088">Index</A>]</center>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<A HREF="http://ferret.pmel.noaa.gov/Ferret/contact-us">Contact Us</A>
<br>
<font size=-1>
<address>
<a href="http://www.doc.gov">Dept of Commerce</a> /
<a href="http://www.noaa.gov">NOAA</a> /
<a href="http://www.oar.noaa.gov">OAR</a> /
<a href="http://www.pmel.noaa.gov">PMEL</a> /
<a href="http://ferret.pmel.noaa.gov">Ferret</a>
</address>

<br>
 <a href="http://www.noaa.gov/privacy.html">Privacy Policy</a> | <a href="http://www.noaa.gov/disclaimer.html">Disclaimer</a> | <a href="accessibility.html">Accessibility Statement</a> 

</font>
<!--X-User-Footer-End-->
</body>
</html>
