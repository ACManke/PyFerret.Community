<!-- MHonArc v2.6.18 -->
<!--X-Subject: Re: [ferret_users] dynamic_height.jnl (and @iin, @rsum in general) -->
<!--X-From-R13: Oaqerj Ivggraoret &#45; @AOO Trqreny <naqerj.jvggraoretNabnn.tbi> -->
<!--X-Date: Sun, 6 Feb 2022 10:10:34 &#45;0800 -->
<!--X-Message-Id: CAKoe08Swi&#45;Ffr43ZeU3540h9AT7g7RabT=yomoE8yK+Qv&#45;v1Wg@mail.gmail.com -->
<!--X-Content-Type: multipart/related -->
<!--X-Reference: CAK0Qe2OH&#45;O&#45;ezGndAMFVT0sGRHZPnMjZ7mvfs9NjjFq9DaXJaA@mail.gmail.com -->
<!--X-Derived: pngHOc1O6XfeW.png -->
<!--X-Head-End-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Re: [ferret_users] dynamic_height.jnl (and @iin, @rsum in general)</title>
</head>
<body>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<HR>
<center>[<a href="msg01088.html">Thread Prev</a>][<a href="msg01090.html">Thread Next</a>][<A HREF="threads.html#01089">Index</A>]</center>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h1>Re: [ferret_users] dynamic_height.jnl (and @iin, @rsum in general)</h1>
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><strong>To</strong>: <strong>William Kessler - NOAA Federal &lt;<a href="mailto:william.s.kessler@DOMAIN.HIDDEN">william.s.kessler@xxxxxxxx</a>&gt;</strong></li>
<li><strong>Subject</strong>: <strong>Re: [ferret_users] dynamic_height.jnl (and @iin, @rsum in general)</strong></li>
<li><strong>From</strong>: <strong>Andrew Wittenberg - NOAA Federal &lt;<a href="mailto:andrew.wittenberg@DOMAIN.HIDDEN">andrew.wittenberg@xxxxxxxx</a>&gt;</strong></li>
<li>Date: Sun, 6 Feb 2022 13:09:55 -0500</li>
<li>Arc-authentication-results: i=2; mx.google.com;       dkim=pass header.i=@noaa.gov header.s=google header.b=NKTbdxRS;       spf=pass (google.com: domain of <a href="mailto:andrew.wittenberg@DOMAIN.HIDDEN">andrew.wittenberg@xxxxxxxx</a> designates 209.85.220.41 as permitted sender) smtp.mailfrom=<a href="mailto:andrew.wittenberg@DOMAIN.HIDDEN">andrew.wittenberg@xxxxxxxx</a>;       dmarc=pass (p=REJECT sp=REJECT dis=NONE) header.from=noaa.gov</li>
<li>Arc-authentication-results: i=1; mx.google.com;       dkim=pass header.i=@noaa.gov header.s=google header.b=NKTbdxRS;       spf=pass (google.com: domain of <a href="mailto:andrew.wittenberg@DOMAIN.HIDDEN">andrew.wittenberg@xxxxxxxx</a> designates 209.85.220.41 as permitted sender) smtp.mailfrom=<a href="mailto:andrew.wittenberg@DOMAIN.HIDDEN">andrew.wittenberg@xxxxxxxx</a>;       dmarc=pass (p=REJECT sp=REJECT dis=NONE) header.from=noaa.gov</li>
<li>Arc-message-signature: i=2; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;        h=list-archive:list-help:list-post:list-id:mailing-list:precedence:cc         :to:subject:message-id:date:from:in-reply-to:references:mime-version         :dkim-signature;        bh=s93+punf7ZkhFD9txO2XX+vQSA6nenhhZKUy5A7yivc=;        b=pHPuGoYN3g+f0BZLmHYQogSee/hgub5q9QkJ8cWbDwSkY4psiJRpbutYqhk/gHCL3x         H2J/pBR1UYQtYMXO6RE2EYsJ0+dOMMF4eSSIqjauTCPqn/kEgZnwi1xFA7FJ5+lI/ap9         SkMTgZGHV4Bdp08fzNPSZJpO81uTTIxrbGbpLVuyTbwakjYmrX/WSCBI+NMtDLqxUjjV         Q7SjcuUDYz2WsfZP3qQWPZhnMAEpNRSa0mFCDSNShOnq3ZIrjxk0LM3JtuSeDMS3lcnb         dDxJH6o5shI2RM7QOlxiez12w9Kk9Kbsz0p4BKrdlT/JBG++DBunwTTKn7Tc+c+e1sdJ         fXvQ==</li>
<li>Arc-message-signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;        h=cc:to:subject:message-id:date:from:in-reply-to:references         :mime-version:dkim-signature;        bh=s93+punf7ZkhFD9txO2XX+vQSA6nenhhZKUy5A7yivc=;        b=mb+wzgmtIJbGzaA6RW5LEPeJd0V55GxwkVYYavIuHbO5/w1jLDiZ+LprufkmBtkAub         iVdPqDgaRtHuzMlkwT2x3iCK9qzQuIA1xrlF4ggI0v0T0lJ6UIa//8ngTMPoFNa2HpdX         Ic16wT7fDy6jDlEgzH/tUE7Gl0vX8rvGoQzeguae6waCet2/8RDQszaNSXqae9/Yasho         MNqbiYJ7BhXPNiAWn4hnCg590WLDTe0PhztelntFMmEx11xE96K6A5XSPyF8FAxOweLp         5WwajO8nSOB4u7X5x0ST25pzcGM4uFbAtkU6mb33sTGyIZZnPcmUd9rv2oBgZoOhTVXE         wmkw==</li>
<li>Arc-seal: i=2; a=rsa-sha256; t=1644171033; cv=pass;        d=google.com; s=arc-20160816;        b=yzb/jEmend77mZxixeJcVq+ovP9qt9QSjBkZz18R1LHzlCig+DJfGAJUD+/2ZOgImI         s/EMMwRmIWyv0UvSbyS6XcPAP1xiBgrL/tCIhyA/MM/8EcyBMxsAoi5CBUZmt8rkOiFP         GSvIHh48vhJEOarUsZfBjes58zG8OjBavaqKNLtwQQ4DILs9kdgUiNkt7lT62qxTC0po         JTVueqiiTwox3t2L4BD3OqbaCtH/VER3+wO5faumg+PmtdfsEIQMeCBJ1o3Zuh8EDqVC         /hSrYTyV7gTpikD2aOId1qsR4en1YAMv1Dm0YBMcXL3kp5pI0CdOCoaviaUSIwW9FLyG         bByg==</li>
<li>Arc-seal: i=1; a=rsa-sha256; t=1644171032; cv=none;        d=google.com; s=arc-20160816;        b=gewUQUku+FJGVHTpVljRfqVQAExrx71oDN2OxFetK2io4eRE5iBaA5VDsh4apigKSW         cQgLDCtJUVBTxji3vT7iPzllodPkv9VLfl+n64fiF7tR6+ulBfeMpfQObk/YhJF1tnzz         Du44i4c2ufo8dJTlBZ+VUSfgCcocKT2po9lFfioSJHFGrmiw/wtGsALs/1mJ207zU3sQ         saWSHIrP2vwuiCneraAGi/AQZr4n4mQqnurRoeZ8N1pAIN8IjvqBGiMlCENdqIeWV5PA         xSUV3Os/hcKAamBZHaTPNP6DnA8AVoKjfeleZ72jkYSbEerhzXHxfy1Z74VpNHODrnd4         WP+w==</li>
<li>Cc: Ferret &lt;<a href="mailto:ferret_users@DOMAIN.HIDDEN">ferret_users@xxxxxxxx</a>&gt;</li>
<li>Dkim-signature: v=1; a=rsa-sha256; c=relaxed/relaxed;        d=noaa.gov; s=google;        h=mime-version:references:in-reply-to:from:date:message-id:subject:to         :cc:x-original-sender:x-original-authentication-results:precedence         :mailing-list:list-id:list-post:list-help:list-archive;        bh=s93+punf7ZkhFD9txO2XX+vQSA6nenhhZKUy5A7yivc=;        b=m6GbV1q3+8J/aO5TfiKb1t4U2DF1LgX1t0BM+S0igGARnrSE9ysOZgKric4XvwwBYG         wXeMcIVodAVnOdtl8y6T/Znbx2kHpCuI06tS6s2WSbCbs/lr6wjAXacS12GZH0jz+7/F         LCJ8lpLDOm0HOli06ln/E/WALSB5fG64U1JZMLggW0fG+VS6gY2JWFh2REQcH8/SjBae         /WWcTovAykupQpywrwzZcsu3MZ8Uofg1ervhf47Ed5A+66v4ydQbgHJGWF//zA8oLFRx         lgSaMWL5q4tZhGxcL5+Us8mZCdoMbE/YAgIkuk33R05W/4opf46fG5lPopxYd+jLXJXc         1BdQ==</li>
<li>In-reply-to: &lt;<a href="msg01088.html">CAK0Qe2OH-O-ezGndAMFVT0sGRHZPnMjZ7mvfs9NjjFq9DaXJaA@mail.gmail.com</a>&gt;</li>
<li>List-archive: &lt;<a href="https://groups.google.com/a/noaa.gov/group/ferret_users/">https://groups.google.com/a/noaa.gov/group/ferret_users/</a>&gt;</li>
<li>List-help: &lt;<a href="https://support.google.com/a/noaa.gov/bin/topic.py?topic=25838">https://support.google.com/a/noaa.gov/bin/topic.py?topic=25838</a>&gt;, &lt;<a href="mailto:ferret_users+help@noaa.gov">mailto:ferret_users+help@noaa.gov</a>&gt;</li>
<li>List-id: &lt;ferret_users.noaa.gov&gt;</li>
<li>List-post: &lt;<a href="https://groups.google.com/a/noaa.gov/group/ferret_users/post">https://groups.google.com/a/noaa.gov/group/ferret_users/post</a>&gt;, &lt;<a href="mailto:ferret_users@noaa.gov">mailto:ferret_users@noaa.gov</a>&gt;</li>
<li>Mailing-list: list <a href="mailto:ferret_users@DOMAIN.HIDDEN">ferret_users@xxxxxxxx</a>; contact <a href="mailto:ferret_users%2Bowners@DOMAIN.HIDDEN">ferret_users+owners@xxxxxxxx</a></li>
<li>References: &lt;<a href="msg01088.html">CAK0Qe2OH-O-ezGndAMFVT0sGRHZPnMjZ7mvfs9NjjFq9DaXJaA@mail.gmail.com</a>&gt;</li>
<li>Sender: <a href="mailto:owner-ferret_users@DOMAIN.HIDDEN">owner-ferret_users@xxxxxxxx</a></li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<div dir="ltr"><div dir="ltr"><div class="gmail_default" style="font-family:arial,helvetica,sans-serif">Hi Billy,</div><div class="gmail_default" style="font-family:arial,helvetica,sans-serif"><br></div><div class="gmail_default" style="font-family:arial,helvetica,sans-serif">Thanks very much for your post!</div><div class="gmail_default" style="font-family:arial,helvetica,sans-serif"><br></div><div class="gmail_default" style="font-family:arial,helvetica,sans-serif">Relevant to this, check out&#xA0;<a rel="nofollow" href="https://ferret.pmel.noaa.gov/Ferret/documentation/users-guide/variables-xpressions/XPRESSIONS#_VPINDEXENTRY_436">Chapter 3, Section 2.4.5</a> of the User&#39;s Guide, &quot;Method 3&quot; toward the end of that subsection, for a description of the new @IIN &quot;regridding transformation&quot; (rather than the older &quot;regular transformation&quot; form that the script currently uses).&#xA0; The regridding form was introduced in Ferret v7.4.2 (summer 2018?), largely to address the half-cell shift that you mentioned in the regular form --&#xA0; namely that the integral-to-edge values were placed at the cell&#xA0;centers of the original axis.&#xA0; It&#39;s better to either have the integral-to-center values placed at the cell centers, or the integral-to-edge values placed at the cell edges.</div><div class="gmail_default" style="font-family:arial,helvetica,sans-serif"><br></div><div class="gmail_default" style="font-family:arial,helvetica,sans-serif">This can now be done very easily, using the &quot;regridding form&quot; of @IIN, which allows one to obtain the indefinite integral at arbitrary points.&#xA0; These points can be the grid cell centers (e.g. if you regrid to the original axis, Z[GZ=my_variable]), the grid cell edges (if you regrid to the cell edges at, say, ZBOXHI[GZ=my_variable] or ZBOXLO[GZ=my_variable]), or any other set of target points defined with DEFINE AXIS.&#xA0; Simply regrid to that target axis using: integrand[GZ=target_z_axis@IIN].</div><div class="gmail_default" style="font-family:arial,helvetica,sans-serif"><br></div><div class="gmail_default" style="font-family:arial,helvetica,sans-serif">Andrew</div><br></div><br><div class="gmail_quote"><div dir="ltr" class="gmail_attr">On Sat, Feb 5, 2022 at 2:40 PM William Kessler - NOAA Federal &lt;<a rel="nofollow" href="mailto:william.s.kessler@xxxxxxxx">william.s.kessler@xxxxxxxx</a>&gt; wrote:<br></div><blockquote class="gmail_quote" style="margin:0px 0px 0px 0.8ex;border-left:1px solid rgb(204,204,204);padding-left:1ex"><div dir="ltr">Hi Ferreters -<br><br>I happened to look at our standard dynamic height script today. <br>(On my system it is .../opt/miniconda3/pkgs/pyferret-7.6.3-py37hfb0c5.1/go/dynamic_height.jnl) <br><div>(comments say &quot;updated in 10/93&quot; ... before some of you were even born ...)</div><div>(the script is also attached FYI)<br></div><br>I think there&#39;s a subtle error in this script, due to the upward indefinite integral. <br>Beyond dynamic height, the issue occurs anytime where @iin (or @rsum) is used.<br><br>The relevant parts of the dynamic_height.jnl algorithm are:<br><br>! Standard _expression_ for specific volume anomaly <br>let SVanom = 1/rho_UN(dyn_s,dyn_t,dyn_p) - 1/rho_UN(35,0,dyn_p) &#xA0;! dyn_[s,t,p] are temp,salinity,pressure<br><br>! The _expression_ for the top-to-bottom integral is straightforward:<br>let/title=&quot;Dynamic Height(dyn-cm)&quot; DYN_HT &#xA0;= 1E5 * dyn_mask * SVanom[z=@din] &#xA0; ! (dyn_mask excludes incomplete profiles)<br><br>! But for a z-dependent result, the direction of the z-axis and of integration must be considered.<br>! The z-axis is typically DOWNWARD (/DEPTH in the axis definition), but the intended integration is UPWARD.<br>! Thus the indefinite integral @iin needs to be reversed using @din minus @iin. <br>! In the script this is:<br><br>let/title=&quot;Dynamic Height(dyn-cm)&quot; DYN_HTz = 1E5 * dyn_mask * (SVanom[z=@din]-SVanom[z=@iin])<br><br>! However, the user probably expects the value to be at the same depths as the density data, namely at the center of each grid cell.<br><br>! But the script&#39;s _expression_ integrates completely through each grid cell, giving the value of the integral at the TOP of the cell.<br><br>! - - - - - - - - -<br>! A simple way to see what&#39;s happening is with a simple example of the results of @din - @iin, defining an example that can be followed in your head:<br><br>define axis/z/depth zdep={1,2,3,4,5} &#xA0; &#xA0; &#xA0; ! simple downward z-axis<br>let zvals = 2*z[gz=zdep] &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; ! variable on this axis with values twice the axis value<br><br><div>! plot ZVALS, its downward integral and two versions of its upward integral (attached png file)</div><div>! (also include a downward @iin integration: red and brown lines)<br></div>plot/line/sym=27/thick=2/vli=0:5.5/hli=0:31:5 &#xA0;zvals,zvals[z=@iin],zvals[z=@din]-zvals[z=@iin],zvals[z=@din]-(zvals[z=@iin]-zvals*zbox/2),zvals[z=@iin]-zvals*zbox/2<br><br><div>! list the relevant pieces, including the grid cell size and limits:</div>list z[gz=zdep],zbox[gz=zdep],zboxlo[gz=zdep],zboxhi[gz=zdep],zvals,zvals[z=@iin],zvals[z=@din]-zvals[z=@iin],zvals[z=@din]-(zvals[z=@iin]-zvals*zbox/2),zvals[z=@iin]-zvals*zbox/2<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;Z: 0.5 to 5.5<br>&#xA0;Column &#xA0;1: Z is Z (axis ZDEP)<br>&#xA0;Column &#xA0;2: ZBOX is ZBOX (axis ZDEP)<br>&#xA0;Column &#xA0;3: ZBOXLO is ZBOXLO (axis ZDEP)<br>&#xA0;Column &#xA0;4: ZBOXHI is ZBOXHI (axis ZDEP)<br>&#xA0;Column &#xA0;5: ZVALS is 2*Z[GZ=ZDEP]<br>&#xA0;Column &#xA0;6: ZVALS[Z=@IIN] is 2*Z[GZ=ZDEP] (indef. integ. on Z)&#xA0;&#xA0; ! simple downward @iin<br>&#xA0;Column &#xA0;7: EX#7 is ZVALS[Z=@DIN]-ZVALS[Z=@IIN]&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; ! integration as in dynamic_height.jnl<br>&#xA0;Column &#xA0;8: EX#8 is ZVALS[Z=@DIN]-(ZVALS[Z=@IIN]-ZVALS*ZBOX/2)&#xA0;&#xA0; ! I think this is correct for DH<br>&#xA0;Column &#xA0;9: EX#9 is ZVALS[Z=@IIN]-ZVALS*ZBOX/2&#xA0;&#xA0;&#xA0;&#xA0;&#xA0;&#xA0; ! correct downward integration<br>&#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0; &#xA0;Z &#xA0; ZBOX &#xA0;ZBOXLO ZBOXHI &#xA0;ZVALS &#xA0;ZVALS &#xA0;EX#7 &#xA0; EX#8 &#xA0; EX#9<br>1 &#xA0; / 1: &#xA0;1.000 &#xA0;1.000 &#xA0;0.500 &#xA0;1.500 &#xA0; 2.00 &#xA0; 2.00 &#xA0;28.00 &#xA0;29.00 &#xA0; 1.00<br>2 &#xA0; / 2: &#xA0;2.000 &#xA0;1.000 &#xA0;1.500 &#xA0;2.500 &#xA0; 4.00 &#xA0; 6.00 &#xA0;24.00 &#xA0;26.00 &#xA0; 4.00<br>3 &#xA0; / 3: &#xA0;3.000 &#xA0;1.000 &#xA0;2.500 &#xA0;3.500 &#xA0; 6.00 &#xA0;12.00 &#xA0;18.00 &#xA0;21.00 &#xA0; 9.00<br>4 &#xA0; / 4: &#xA0;4.000 &#xA0;1.000 &#xA0;3.500 &#xA0;4.500 &#xA0; 8.00 &#xA0;20.00 &#xA0;10.00 &#xA0;14.00 &#xA0;16.00<br>5 &#xA0; / 5: &#xA0;5.000 &#xA0;1.000 &#xA0;4.500 &#xA0;5.500 &#xA0;10.00 &#xA0;30.00 &#xA0; 0.00 &#xA0; 5.00 &#xA0;25.00<br><br>We&#39;re comparing EX#7 (as in dynamic_height.jnl, green line on plot) and EX#8 (I think is correct, blue line).<br>Which is correct?<br><br>The issue is that the value of the integral is understood as being at the grid cell centers.<br><br>Starting at a value of 30 at the bottom of the deepest cell (z=5.5), the first value is halfway up that cell, thus half of ZVALS[z=5], namely 5. An _expression_ like in dynamic_height.jnl gives 0. <br><br>Following the blue line, the value of the integral at the highest gridcell (z=1) is 29 (not 30 because this integration is not to the top of the cell at z=0.5). Nor is is 28, which is what an integration like in dynamic_height.jnl would give. <br>! - - - - - - - - -<br><br>Thus I think the correct _expression_ for the dynamic height integration should be like EX#8:<br><br>let/title=&quot;Dynamic Height(dyn-cm)&quot; DYN_HTz = 1E5 * dyn_mask * (SVanom[z=@din]-(SVanom[z=@iin]-SVanom*ZBOX/2))<br><br>The same issue occurs in any @iin integration. <br>Consider the red line in the attached plot (ZVALS[z=@iin], EX#9 in the listing above). <br>At the first grid cell (z=1) the value is 2, the whole value of ZVALS[k=1], as if the integration had been carried through the whole cell (thus to z=1.5).<br><br>A corrected version is the brown line: zvals[z=@iin]-zvals*zbox/2, namely to the center of each cell.<br><br>=&gt; Bottom line is that the results of @iin and @rsum need to be considered with care. <br><div>&#xA0; &#xA0;Where exactly do you expect the result to apply?</div><div><br></div><div>Billy K<br></div><div><br></div><div><br></div><div><br></div><div><img src="pngHOc1O6XfeW.png" alt="zvals_test2.png" width="558" height="482"><br><br></div></div>
</blockquote></div></div>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="01090" href="msg01090.html">Re: [ferret_users] dynamic_height.jnl (and @iin, @rsum in general)</a></strong>
<ul><li><em>From:</em> William Kessler</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<ul><li><strong>References</strong>:
<ul>
<li><strong><a name="01088" href="msg01088.html">[ferret_users] dynamic_height.jnl (and @iin, @rsum in general)</a></strong>
<ul><li><em>From:</em> William Kessler - NOAA Federal</li></ul></li>
</ul></li></ul>
<!--X-References-End-->
<!--X-BotPNI-->
<UL>
<li>Previous by thread:
<strong><a href="msg01088.html">[ferret_users] dynamic_height.jnl (and @iin, @rsum in general)</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg01090.html">Re: [ferret_users] dynamic_height.jnl (and @iin, @rsum in general)</a></strong>
</li>

</UL>
<center>[<a href="msg01088.html">Thread Prev</a>][<a href="msg01090.html">Thread Next</a>][<A HREF="threads.html#01089">Index</A>]</center>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<A HREF="http://ferret.pmel.noaa.gov/Ferret/contact-us">Contact Us</A>
<br>
<font size=-1>
<address>
<a href="http://www.doc.gov">Dept of Commerce</a> /
<a href="http://www.noaa.gov">NOAA</a> /
<a href="http://www.oar.noaa.gov">OAR</a> /
<a href="http://www.pmel.noaa.gov">PMEL</a> /
<a href="http://ferret.pmel.noaa.gov">Ferret</a>
</address>

<br>
 <a href="http://www.noaa.gov/privacy.html">Privacy Policy</a> | <a href="http://www.noaa.gov/disclaimer.html">Disclaimer</a> | <a href="accessibility.html">Accessibility Statement</a> 

</font>
<!--X-User-Footer-End-->
</body>
</html>
